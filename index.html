<!DOCTYPE html>
// auth.js - Funcionalidades de autenticación y gestión de usuarios

/**
 * Módulo de autenticación para FacturaML
 * Maneja el registro de usuarios, inicio de sesión y gestión de sesiones
 */

// Importar funciones de utilidad
import { showSuccess, showError } from './utils.js';

/**
 * Iniciar sesión con email y contraseña
 * @returns {boolean} - true si el inicio de sesión es exitoso
 */
function loginUser() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        showError('Por favor ingresa tu correo y contraseña');
        return false;
    }
    
    // Obtener usuarios del localStorage
    const users = JSON.parse(localStorage.getItem('users')) || [];
    
    // Buscar usuario
    const user = users.find(u => u.email === email && u.password === password);
    
    if (user) {
        // Guardar sesión
        localStorage.setItem('currentUser', JSON.stringify(user));
        showSuccess('¡Inicio de sesión exitoso!');
        
        // Redireccionar al dashboard
        setTimeout(() => {
            window.location.href = 'dashboard.html';
        }, 1500);
        return true;
    } else {
        showError('Correo o contraseña incorrectos');
        return false;
    }
}

/**
 * Validar el formulario de registro
 * @returns {boolean} - true si el formulario es válido
 */
function validateRegisterForm() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const companyName = document.getElementById('companyName').value;
    const companyRif = document.getElementById('companyRif').value;
    const address = document.getElementById('address').value;
    const phone = document.getElementById('phone').value;
    
    if (!email || !password || !companyName || !companyRif || !address || !phone) {
        showError('Por favor completa todos los campos obligatorios');
        return false;
    }
    
    // Validar formato de correo
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showError('Por favor ingresa un correo electrónico válido');
        return false;
    }
    
    // Validar formato de RIF (J-12345678-9)
    const rifRegex = /^[JGVE]-\d{8}-\d{1}$/;
    if (!rifRegex.test(companyRif)) {
        showError('El formato del RIF debe ser J-12345678-9');
        return false;
    }
    
    // Verificar si el correo ya está registrado
    const users = JSON.parse(localStorage.getItem('users')) || [];
    if (users.some(user => user.email === email)) {
        showError('Este correo ya está registrado');
        return false;
    }
    
    return true;
}

/**
 * Registrar un nuevo usuario
 * @returns {boolean} - true si el registro es exitoso
 */
function registerUser() {
    if (!validateRegisterForm()) return false;
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const companyName = document.getElementById('companyName').value;
    const companyRif = document.getElementById('companyRif').value;
    const address = document.getElementById('address').value;
    const phone = document.getElementById('phone').value;
    const isSpecialTaxpayer = document.getElementById('isSpecialTaxpayer').checked;
    
    // Crear objeto de usuario
    const newUser = {
        id: Date.now(), // Usar timestamp como ID simple
        email,
        password, // En una aplicación real, deberías hashear la contraseña
        companyName,
        companyRif,
        address,
        phone,
        isSpecialTaxpayer,
        registrationDate: new Date().toISOString()
    };
    
    // Obtener usuarios actuales y agregar el nuevo
    const users = JSON.parse(localStorage.getItem('users')) || [];
    users.push(newUser);
    
    // Guardar en localStorage
    localStorage.setItem('users', JSON.stringify(users));
    
    // Mostrar mensaje de éxito
    showSuccess('¡Registro exitoso! Ahora puedes iniciar sesión');
    
    // Limpiar formulario
    document.getElementById('email').value = '';
    document.getElementById('password').value = '';
    document.getElementById('companyName').value = '';
    document.getElementById('companyRif').value = '';
    document.getElementById('address').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('isSpecialTaxpayer').checked = false;
    
    // Cambiar a tab de login (esta función estaría en ui.js)
    if (typeof switchTab === 'function') {
        setTimeout(() => {
            switchTab('login');
        }, 1500);
    }
    
    return true;
}

/**
 * Cerrar sesión del usuario actual
 */
function logoutUser() {
    localStorage.removeItem('currentUser');
    window.location.href = 'index.html';
}

/**
 * Verificar si el usuario está autenticado
 * @returns {Object|null} - Objeto de usuario o null si no está autenticado
 */
function checkAuthentication() {
    const currentUser = localStorage.getItem('currentUser');
    
    if (!currentUser) {
        window.location.href = 'index.html';
        return null;
    }
    
    return JSON.parse(currentUser);
}

/**
 * Obtener el usuario actual
 * @returns {Object|null} - Objeto de usuario o null si no hay sesión
 */
function getCurrentUser() {
    const currentUser = localStorage.getItem('currentUser');
    return currentUser ? JSON.parse(currentUser) : null;
}

/**
 * Actualizar los datos del perfil del usuario
 * @param {Object} updatedData - Datos actualizados del perfil
 * @returns {boolean} - true si la actualización es exitosa
 */
function updateUserProfile(updatedData) {
    const currentUser = getCurrentUser();
    
    if (!currentUser) {
        return false;
    }
    
    // Obtener todos los usuarios
    const users = JSON.parse(localStorage.getItem('users')) || [];
    
    // Actualizar datos del usuario en la "base de datos"
    const userIndex = users.findIndex(u => u.id === currentUser.id);
    
    if (userIndex !== -1) {
        // Actualizar los campos permitidos
        users[userIndex] = {
            ...users[userIndex],
            companyName: updatedData.companyName || users[userIndex].companyName,
            companyRif: updatedData.companyRif || users[userIndex].companyRif,
            address: updatedData.address || users[userIndex].address,
            phone: updatedData.phone || users[userIndex].phone,
            isSpecialTaxpayer: updatedData.isSpecialTaxpayer !== undefined ? 
                updatedData.isSpecialTaxpayer : users[userIndex].isSpecialTaxpayer
        };
        
        // Si se actualiza la contraseña
        if (updatedData.password) {
            users[userIndex].password = updatedData.password;
        }
        
        // Actualizar el usuario en localStorage
        localStorage.setItem('users', JSON.stringify(users));
        localStorage.setItem('currentUser', JSON.stringify(users[userIndex]));
        
        return true;
    }
    
    return false;
}

// Exportar funciones públicas del módulo
export {
    loginUser,
    registerUser,
    logoutUser,
    checkAuthentication,
    getCurrentUser,
    updateUserProfile
};
