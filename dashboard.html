<!-- Parte 1: Estructura, estilos y formulario inicial (~1000 líneas) -->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturador ML Venezuela - Dashboard</title>
    <style>
        /* ===========================================================================
         * ESTILOS GENERALES - PARTE 1
         * ===========================================================================
         * Estilos completos para el dashboard y el formulario, basados en tu código
         * original con mejoras en responsividad y consistencia visual.
         * Paleta de colores: azul (#2968c8), amarillo (#ffe600).
         * =========================================================================== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .navbar {
            background-color: #ffe600;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease;
        }
        .navbar:hover {
            background-color: #e6cc00;
        }
        .logo {
            font-weight: bold;
            font-size: 24px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .nav-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-info {
            margin-right: 15px;
            font-size: 16px;
            color: #444;
            font-style: italic;
        }
        .logout-btn {
            background: #2968c8;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }
        .logout-btn:hover {
            background: #1d4f9e;
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #ddd;
        }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }
        .dashboard-title {
            font-size: 24px;
            font-weight: bold;
            color: #2968c8;
            text-transform: uppercase;
        }
        .dashboard-stats {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            border: 1px solid #e9ecef;
        }
        .stat-card {
            flex: 1;
            text-align: center;
            padding: 15px;
            border-right: 1px solid #eee;
            background: #fafafa;
            border-radius: 4px;
            transition: transform 0.2s;
            overflow: hidden;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            background: #e9ecef;
        }
        .stat-card:last-child {
            border-right: none;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #2968c8;
            margin-bottom: 5px;
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            from { opacity: 0.8; }
            to { opacity: 1; }
        }
        .stat-label {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 4px 4px 0 0;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }
        .tab:hover {
            background: #e9ecef;
            border-bottom-color: #ccc;
        }
        .tab.active {
            border-bottom: 3px solid #2968c8;
            font-weight: bold;
            color: #2968c8;
            background: #fff;
        }
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #2968c8;
        }

        .tab-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            min-height: 400px;
            transition: opacity 0.3s ease;
        }
        .invoice-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .form-group {
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            color: #333;
            text-transform: capitalize;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
            text-align: left;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2968c8;
            box-shadow: 0 0 5px rgba(41,104,200,0.3);
            background: #f1f8ff;
        }
        .btn {
            background: #2968c8;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn:hover {
            background: #1d4f9e;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: #fff;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            vertical-align: middle;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-transform: uppercase;
        }
        .items-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: border-color 0.3s ease;
        }
        .items-table button {
            width: 100%;
            padding: 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .items-table button:hover {
            background: #c82333;
        }
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .summary-table {
            width: 50%;
            margin-left: auto;
            margin-top: 20px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .summary-table td {
            padding: 8px 15px;
        }
        .summary-table tr:last-child {
            font-weight: bold;
            font-size: 18px;
            background: #e9ecef;
        }
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-info {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        .hidden {
            display: none;
        }
        .has-error input, .has-error select {
            border-color: #dc3545 !important;
            background-color: #fff5f5;
        }

        /* Media Queries para responsividad */
        @media (max-width: 768px) {
            .dashboard-stats {
                flex-direction: column;
                gap: 15px;
            }
            .stat-card {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
            .stat-card:last-child {
                border-bottom: none;
            }
            .invoice-form {
                grid-template-columns: 1fr;
            }
            .action-buttons {
                justify-content: center;
            }
            .summary-table {
                width: 100%;
            }
            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">FacturaML</div>
        <div class="nav-user">
            <div class="user-info" id="userDisplayName">Cargando...</div>
            <button class="logout-btn" id="logoutButton">Cerrar Sesión</button>
        </div>
    </div>
    
    <div class="container">
        <div class="dashboard-header">
            <div class="dashboard-title">Panel de Control</div>
            <div>
                <button class="btn" id="newInvoiceBtnHeader">Nueva Factura</button>
            </div>
        </div>
        
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-number" id="availableInvoices">0</div>
                <div class="stat-label">Facturas Disponibles</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="issuedInvoices">0</div>
                <div class="stat-label">Facturas Emitidas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalAmount">0.00 Bs</div>
                <div class="stat-label">Monto Total Facturado</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lastInvoiceNumber">-</div>
                <div class="stat-label">Último Número de Control</div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" id="tabInvoices">Facturas</div>
            <div class="tab" id="tabClients">Clientes</div>
            <div class="tab" id="tabProfile">Mi Perfil</div>
        </div>
        
        <div class="tab-content" id="contentInvoices">
            <div id="alertContainer"></div>
            <div id="invoiceList">
                <h3>Historial de Facturas</h3>
                <table id="invoicesTable">
                    <thead>
                        <tr>
                            <th>Número</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Monto</th>
                            <th>IVA</th>
                            <th>IGTF</th>
                            <th>Total</th>
                            <th>Total USD</th>
                            <th>Tipo</th>
                            <th>Código Operación</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTableBody">
                        <!-- Rows will be populated dynamically -->
                    </tbody>
                </table>
            </div>
            <div id="invoiceForm" class="invoice-form tab-content hidden">
    <h2>Nueva Factura</h2>
    <div class="form-section">
        <h3>Información del Cliente</h3>
        <div class="form-group">
            <label for="clientName">Nombre o Razón Social*</label>
            <input type="text" id="clientName" required>
        </div>
        <div class="form-group">
            <label for="clientId">Cédula o RIF*</label>
            <input type="text" id="clientId" placeholder="Ej: V-12345678 o J-12345678-9" required>
        </div>
        <div class="form-group">
            <label for="clientAddress">Dirección*</label>
            <input type="text" id="clientAddress" required>
        </div>
        <div class="form-group">
            <label for="clientPhone">Teléfono</label>
            <input type="text" id="clientPhone">
        </div>
        <div class="form-group">
            <label for="clientEmails">Correos Electrónicos del Cliente (separados por comas)*</label>
            <input type="text" id="clientEmails" placeholder="Ej: cliente1@correo.com, cliente2@correo.com" required>
        </div>
    </div>
    <!-- Resto del formulario (Información de la Factura, Artículos, Resumen, etc.) sigue igual -->
    <div class="form-section">
        <h3>Información de la Factura</h3>
        <div class="form-group">
            <label for="invoiceDate">Fecha de Emisión*</label>
            <input type="date" id="invoiceDate" required>
        </div>
        <div class="form-group">
            <label for="docType">Tipo de Documento*</label>
            <select id="docType" required>
                <option value="">Selecciona...</option>
                <option value="factura">Factura</option>
                <option value="nota_credito">Nota de Crédito</option>
                <option value="nota_debito">Nota de Débito</option>
            </select>
        </div>
        <div class="form-group">
            <label for="operationCode">Código de Operación</label>
            <input type="text" id="operationCode">
        </div>
        <div class="form-group">
            <label for="paymentMethod">Método de Pago*</label>
            <select id="paymentMethod" required>
                <option value="">Selecciona...</option>
                <option value="efectivo_bs">Efectivo (Bs.)</option>
                <option value="transferencia_bs">Transferencia (Bs.)</option>
                <option value="efectivo_usd">Efectivo (USD)</option>
                <option value="transferencia_usd">Transferencia (USD)</option>
            </select>
        </div>
        <div class="form-group">
            <label for="invoiceNotes">Notas</label>
            <textarea id="invoiceNotes"></textarea>
        </div>
    </div>
    <!-- Resto del formulario (Artículos, Resumen, Botones) -->
    <div class="form-section">
        <h3>Artículos</h3>
        <table class="items-table">
            <thead>
                <tr>
                    <th>Descripción</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Subtotal</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody id="itemsTableBody"></tbody>
        </table>
        <button id="addItemBtn" class="btn">+ Agregar Artículo</button>
    </div>
    <div class="form-section">
        <h3>Resumen</h3>
        <table class="summary-table">
            <tr>
                <td>Subtotal</td>
                <td id="summarySubtotal">0.00 Bs.</td>
            </tr>
            <tr>
                <td>IVA (16%)</td>
                <td id="summaryIva">0.00 Bs.</td>
            </tr>
            <tr id="igtfRow" style="display: none;">
                <td>IGTF (3%)</td>
                <td id="summaryIgtf">0.00 Bs.</td>
            </tr>
            <tr id="specialTaxRow" style="display: none;">
                <td>Retención Especial</td>
                <td id="summarySpecialTax">0.00 Bs.</td>
            </tr>
            <tr>
                <td>Total</td>
                <td id="summaryTotal">0.00 Bs.</td>
            </tr>
        </table>
    </div>
    <div class="action-buttons">
        <button id="cancelInvoiceBtn" class="btn btn-secondary">Cancelar</button>
        <button id="previewInvoiceBtn" class="btn btn-secondary">Previsualizar</button>
        <button id="saveInvoiceBtn" class="btn btn-success">Guardar Factura</button>
    </div>
</div> 
                <div class="form-section">
                    <h3 class="section-title">Información de la Factura</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoiceDate">Fecha de Emisión*</label>
                            <input type="date" id="invoiceDate" required>
                        </div>
                        <div class="form-group">
                            <label for="docType">Tipo de Documento*</label>
                            <select id="docType" required>
                                <option value="factura">Factura</option>
                                <option value="nota_credito">Nota de Crédito</option>
                                <option value="nota_debito">Nota de Débito</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="operationCode">Código de Operación</label>
                            <input type="text" id="operationCode" placeholder="Ej: COD-001">
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">Método de Pago*</label>
                            <select id="paymentMethod" required>
                                <option value="transferencia_bs">Transferencia en Bs.</option>
                                <option value="pago_movil">Pago Móvil</option>
                                <option value="efectivo_bs">Efectivo en Bs.</option>
                                <option value="efectivo_usd">Efectivo en USD</option>
                                <option value="transferencia_usd">Transferencia en USD</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="invoiceNotes">Notas de la Factura</label>
                        <textarea id="invoiceNotes" rows="2"></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title">Artículos</h3>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th width="40%">Descripción</th>
                                <th width="15%">Cantidad</th>
                                <th width="20%">Precio Unitario</th>
                                <th width="20%">Subtotal</th>
                                <th width="5%"></th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <tr>
                                <td><input type="text" class="item-description" required></td>
                                <td><input type="number" class="item-quantity" min="1" value="1" required></td>
                                <td><input type="number" step="0.01" class="item-price" min="0" value="0.00" required></td>
                                <td class="item-subtotal">0.00</td>
                                <td><button class="btn-secondary remove-item">X</button></td>
                            </tr>
                        </tbody>
                    </table>
                    <button class="btn btn-secondary" id="addItemBtn" style="margin-top: 10px">Agregar Artículo</button>
                    
                    <table class="summary-table">
                        <tr>
                            <td>Subtotal:</td>
                            <td class="text-right" id="summarySubtotal">0.00 Bs.</td>
                        </tr>
                        <tr>
                            <td>IVA (16%):</td>
                            <td class="text-right" id="summaryIva">0.00 Bs.</td>
                        </tr>
                        <tr id="igtfRow">
                            <td>IGTF (3%):</td>
                            <td class="text-right" id="summaryIgtf">0.00 Bs.</td>
                        </tr>
                        <tr id="specialTaxRow">
                            <td>Retención Contribuyente Especial:</td>
                            <td class="text-right" id="summarySpecialTax">0.00 Bs.</td>
                        </tr>
                        <tr>
                            <td>Total:</td>
                            <td class="text-right" id="summaryTotal">0.00 Bs.</td>
                        </tr>
                    </table>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="cancelInvoiceBtn">Cancelar</button>
                    <button class="btn btn-success" id="previewInvoiceBtn">Vista Previa</button>
                    <button class="btn" id="saveInvoiceBtn">Generar Factura</button>
                </div>
            </div>
        </div>
        
        <div class="tab-content hidden" id="contentClients">
            <h3>Mis Clientes</h3>
            <table id="clientsTable">
                <thead>
                    <tr>
                        <th>Nombre/Razón Social</th>
                        <th>Cédula/RIF</th>
                        <th>Dirección</th>
                        <th>Teléfono</th>
                        <th>Facturas Emitidas</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="clientsTableBody">
                    <!-- Rows will be populated dynamically -->
                </tbody>
            </table>
        </div>
        
      <div id="contentProfile" class="tab-content hidden">
    <h2>Mi Perfil</h2>
    <div class="form-group">
        <label for="profileCompanyName">Nombre o Razón Social</label>
        <input type="text" id="profileCompanyName" readonly>
    </div>
    <div class="form-group">
        <label for="profileRif">RIF</label>
        <input type="text" id="profileRif" readonly>
    </div>
    <div class="form-group">
        <label for="profileAddress">Dirección Fiscal</label>
        <input type="text" id="profileAddress" readonly>
    </div>
    <div class="form-group">
        <label for="profilePhone">Teléfono</label>
        <input type="text" id="profilePhone" readonly>
    </div>
    <div class="form-group">
        <label>Correos Electrónicos</label>
        <ul id="profileEmailsList"></ul>
    </div>
    <div class="form-group">
        <label for="profileTaxStatus">Estatus Fiscal</label>
        <p id="profileTaxStatus"></p>
    </div>
</div>
            <div class="form-row">
                <div class="form-group">
                    <label for="profileAddress">Dirección Fiscal</label>
                    <input type="text" id="profileAddress" readonly>
                </div>
                <div class="form-group">
                    <label for="profilePhone">Teléfono</label>
                    <input type="text" id="profilePhone" readonly>
                </div>
            </div>
            <div class="form-group">
                <label for="profileEmail">Correo Electrónico</label>
                <input type="email" id="profileEmail" readonly>
            </div>
            <div class="form-group">
                <label>Estatus de Contribuyente</label>
                <div id="profileTaxStatus">Normal</div>
            </div>
            <div style="margin-top: 30px;">
                <h3>Plan de Facturación</h3>
                <div class="alert alert-info">
                    Tienes activado el plan de <strong>Talonario de 100 Facturas</strong>
                </div>
                <div id="lowInvoicesWarning" class="alert alert-warning hidden">
                    Te quedan menos de 10 facturas disponibles. ¡Considera comprar más pronto!
                </div>
                <button class="btn" id="buyMoreInvoicesBtn">Comprar más facturas</button>
            </div>
        </div>
    </div>

    <script>
        // ===========================================================================
        // FUNCIONES BÁSICAS - PARTE 1
        // ===========================================================================
        // Esta sección incluye inicialización, autenticación, formato de datos,
        // alertas, cambio de pestañas, y la lógica inicial para mostrar el formulario.
        // ===========================================================================

        /**
         * Formatea un número como moneda venezolana (Bolívares).
         * @param {number} amount - El monto a formatear.
         * @returns {string} - El monto formateado con comas y "Bs.".
         */
        function formatCurrency(amount) {
            return amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') + ' Bs.';
        }

        /**
         * Formatea una fecha al estilo venezolano.
         * @param {string} dateString - La fecha en formato ISO.
         * @returns {string} - Fecha formateada (dd/mm/yyyy).
         */
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-VE');
        }

        /**
         * Muestra una alerta temporal en la interfaz.
         * @param {string} message - El mensaje a mostrar.
         * @param {string} type - Tipo de alerta (success, warning, danger, info).
         */
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        /**
         * Valida el formato de un RIF o cédula venezolana.
         * @param {string} clientId - El RIF o cédula a validar.
         * @returns {boolean} - True si es válido, false si no.
         */
        function validateClientId(clientId) {
            const rifRegex = /^[VEJPG]-[0-9]{8}-[0-9]$/;
            const cedulaRegex = /^[VE]-[0-9]{1,8}$/;
            return rifRegex.test(clientId) || cedulaRegex.test(clientId);
        }

        /**
         * Valida el formato de un teléfono venezolano (opcional).
         * @param {string} phone - El número de teléfono a validar.
         * @returns {boolean} - True si es válido o vacío, false si no.
         */
        function validatePhone(phone) {
            if (!phone) return true;
            const phoneRegex = /^(\+58|0)[0-9]{10}$/;
            return phoneRegex.test(phone);
        }

        /**
         * Inicializa la aplicación con datos predeterminados si no existen.
         */
        function initializeApp() {
            if (!localStorage.getItem('initialized')) {
                if (!localStorage.getItem('users')) {
                    const users = [{
                        email: 'ejemplo@empresa.com',
                        password: 'password123',
                        companyName: 'Empresa Ejemplo',
                        rif: 'J-12345678-9',
                        address: 'Caracas, Venezuela',
                        phone: '0212-1234567',
                        email: 'ejemplo@empresa.com',
                        isSpecialContributor: true,
                        availableInvoices: 100
                    }];
                    localStorage.setItem('users', JSON.stringify(users));
                }
                if (!localStorage.getItem('invoices')) {
                    localStorage.setItem('invoices', JSON.stringify([]));
                }
                if (!localStorage.getItem('clients')) {
                    localStorage.setItem('clients', JSON.stringify([]));
                }
                if (!localStorage.getItem('lastControlNumber')) {
                    localStorage.setItem('lastControlNumber', '0');
                }
                if (!localStorage.getItem('lastDocNumbers')) {
                    localStorage.setItem('lastDocNumbers', JSON.stringify({ factura: 0, nota_credito: 0, nota_debito: 0 }));
                }
                if (!localStorage.getItem('invoiceLimit')) {
                    localStorage.setItem('invoiceLimit', '100');
                }
                localStorage.setItem('initialized', 'true');
            }
        }

        /**
         * Verifica autenticación y carga datos iniciales.
         */
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('userDisplayName').textContent = currentUser.companyName;
            updateDashboardStats();
            setupEventListeners();
        });

        /**
         * Configura los event listeners básicos.
         */
        function setupEventListeners() {
            document.getElementById('logoutButton').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });
            document.getElementById('tabInvoices').addEventListener('click', () => switchTab('Invoices'));
            document.getElementById('tabClients').addEventListener('click', () => switchTab('Clients'));
            document.getElementById('tabProfile').addEventListener('click', () => switchTab('Profile'));
            document.getElementById('newInvoiceBtnHeader').addEventListener('click', showInvoiceForm);
        }

        /**
         * Cambia la pestaña activa en la interfaz.
         * @param {string} tab - Nombre de la pestaña (Invoices, Clients, Profile).
         */
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(tabElement => tabElement.classList.remove('active'));
            document.getElementById(`content${tab}`).classList.remove('hidden');
            document.getElementById(`tab${tab}`).classList.add('active');
        }

/**
 * Actualiza las estadísticas del dashboard.
 */
function updateDashboardStats() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
    const userInvoices = invoices.filter(invoice => invoice.sellerId === currentUser.email);
    const invoiceLimit = parseInt(localStorage.getItem('invoiceLimit') || '100');
    const lastControlNumber = localStorage.getItem('lastControlNumber') || '0';

    let totalAmount = 0;
    userInvoices.forEach(invoice => totalAmount += invoice.total);

    // Calcular facturas disponibles restando las emitidas del límite total
    const availableInvoices = Math.max(0, invoiceLimit - userInvoices.length);

    document.getElementById('availableInvoices').textContent = availableInvoices;
    document.getElementById('issuedInvoices').textContent = userInvoices.length;
    document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
    document.getElementById('lastInvoiceNumber').textContent = lastControlNumber;

    const lowInvoicesWarning = document.getElementById('lowInvoicesWarning');
    if (availableInvoices < 10) {
        lowInvoicesWarning.classList.remove('hidden');
    } else {
        lowInvoicesWarning.classList.add('hidden');
    }
}
        /**
         * Muestra el formulario de nueva factura.
         */
        function showInvoiceForm() {
            const invoiceLimit = parseInt(localStorage.getItem('invoiceLimit') || '100');
            if (invoiceLimit <= 0) {
                showAlert('No tienes facturas disponibles. Por favor, compra más facturas para continuar.', 'danger');
                return;
            }

            document.getElementById('invoiceList').classList.add('hidden');
            document.getElementById('invoiceForm').classList.remove('hidden');

            // Limpiar el formulario
            document.getElementById('clientName').value = '';
            document.getElementById('clientId').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('docType').value = 'factura';
            document.getElementById('operationCode').value = '';
            document.getElementById('paymentMethod').value = 'transferencia_bs';
            document.getElementById('invoiceNotes').value = '';

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDate').value = today;

            const itemsTableBody = document.getElementById('itemsTableBody');
            itemsTableBody.innerHTML = `
                <tr>
                    <td><input type="text" class="item-description" placeholder="Descripción del artículo" required></td>
                    <td><input type="number" class="item-quantity" min="1" value="1" required></td>
                    <td><input type="number" step="0.01" class="item-price" min="0" value="0.00" placeholder="Precio en Bs." required></td>
                    <td class="item-subtotal">0.00</td>
                    <td><button class="btn-secondary remove-item">X</button></td>
                </tr>
            `;

            document.getElementById('summarySubtotal').textContent = formatCurrency(0);
            document.getElementById('summaryIva').textContent = formatCurrency(0);
            document.getElementById('summaryIgtf').textContent = formatCurrency(0);
            document.getElementById('summarySpecialTax').textContent = formatCurrency(0);
            document.getElementById('summaryTotal').textContent = formatCurrency(0);

            document.getElementById('clientName').focus();
        }

        // ===========================================================================
        // FIN DE LA PARTE 1 (~1000 líneas)
        // ===========================================================================
        // Esta parte incluye la estructura HTML completa, estilos CSS completos,
        // funciones básicas de JavaScript, y el formulario de "Nueva Factura" listo
        // para añadir lógica en la Parte 2.
        // ===========================================================================
    </script>
</html>
<!-- Continuación de la Parte 1: Reemplazar el bloque <script> de la Parte 2 por este -->
<script>
    // ===========================================================================
    // FUNCIONES Y LÓGICA - PARTE 2 (EXTENDIDA)
    // ===========================================================================
    // Esta sección incluye la lógica del formulario de "Nueva Factura" (cálculos,
    // validaciones, guardado), el manejo del historial de facturas con columnas
    // nuevas, botones "VER" e "IMPRIMIR", validaciones avanzadas, y estilos adicionales.
    // ===========================================================================

    /**
     * Calcula los subtotales y totales de los ítems en el formulario.
     * @returns {number} - El subtotal total de todos los ítems.
     */
    function calculateItemTotals() {
        const rows = document.querySelectorAll('#itemsTableBody tr');
        let subtotal = 0;
        let hasErrors = false;

        rows.forEach((row, index) => {
            const description = row.querySelector('.item-description').value.trim();
            const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;

            // Validar cada ítem
            if (!description) {
                row.querySelector('.item-description').parentElement.classList.add('has-error');
                showAlert(`El artículo #${index + 1} necesita una descripción.`, 'warning');
                hasErrors = true;
            } else {
                row.querySelector('.item-description').parentElement.classList.remove('has-error');
            }
            if (quantity <= 0) {
                row.querySelector('.item-quantity').parentElement.classList.add('has-error');
                showAlert(`El artículo #${index + 1} debe tener una cantidad mayor a 0.`, 'warning');
                hasErrors = true;
            } else {
                row.querySelector('.item-quantity').parentElement.classList.remove('has-error');
            }
            if (price <= 0) {
                row.querySelector('.item-price').parentElement.classList.add('has-error');
                showAlert(`El artículo #${index + 1} debe tener un precio mayor a 0.`, 'warning');
                hasErrors = true;
            } else {
                row.querySelector('.item-price').parentElement.classList.remove('has-error');
            }

            const itemSubtotal = quantity * price;
            row.querySelector('.item-subtotal').textContent = formatCurrency(itemSubtotal);
            subtotal += itemSubtotal;
        });

        if (hasErrors) {
            throw new Error('Errores en los ítems de la factura.');
        }

        return subtotal;
    }

    /**
     * Calcula los impuestos (IVA, IGTF, retención) y el total de la factura.
     * @param {number} subtotal - El subtotal de los ítems.
     * @returns {object} - Objeto con los valores calculados.
     */
    function calculateTaxesAndTotal(subtotal) {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const ivaRate = 0.16; // 16% IVA
        const igtfRate = 0.03; // 3% IGTF para pagos en USD
        const specialTaxRate = currentUser.isSpecialContributor ? 0.01 : 0; // 1% para contribuyentes especiales
        const paymentMethod = document.getElementById('paymentMethod').value;

        let iva = subtotal * ivaRate;
        let igtf = (paymentMethod.includes('usd') || paymentMethod.includes('efectivo_usd')) ? subtotal * igtfRate : 0;
        let specialTax = subtotal * specialTaxRate;

        const total = subtotal + iva + igtf + specialTax;

        return { subtotal, iva, igtf, specialTax, total };
    }

    /**
     * Actualiza el resumen de la factura en la interfaz.
     */
    function updateSummary() {
        try {
            const subtotal = calculateItemTotals();
            const { iva, igtf, specialTax, total } = calculateTaxesAndTotal(subtotal);

            document.getElementById('summarySubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('summaryIva').textContent = formatCurrency(iva);
            document.getElementById('summaryIgtf').textContent = formatCurrency(igtf);
            document.getElementById('summarySpecialTax').textContent = formatCurrency(specialTax);
            document.getElementById('summaryTotal').textContent = formatCurrency(total);

            // Mostrar u ocultar filas de impuestos según corresponda
            document.getElementById('igtfRow').style.display = igtf > 0 ? 'table-row' : 'none';
            document.getElementById('specialTaxRow').style.display = specialTax > 0 ? 'table-row' : 'none';
        } catch (error) {
            console.error('Error al actualizar el resumen:', error.message);
            showAlert('Error al calcular los totales. Revisa los ítems.', 'danger');
        }
    }

  /**
 * Valida el formulario antes de guardarlo.
 * @returns {boolean} - True si es válido, false si no.
 */
function validateForm() {
    let isValid = true;
    document.querySelectorAll('.has-error').forEach(el => el.classList.remove('has-error'));

    const clientName = document.getElementById('clientName').value.trim();
    const clientId = document.getElementById('clientId').value.trim();
    const clientAddress = document.getElementById('clientAddress').value.trim();
    const clientPhone = document.getElementById('clientPhone').value.trim();
    const clientEmails = document.getElementById('clientEmails').value.trim();
    const invoiceDate = document.getElementById('invoiceDate').value;
    const docType = document.getElementById('docType').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const rows = document.querySelectorAll('#itemsTableBody tr');

    // Validar información del cliente
    if (!clientName) {
        document.getElementById('clientName').parentElement.classList.add('has-error');
        showAlert('El nombre del cliente es obligatorio.', 'warning');
        isValid = false;
    }
    if (!validateClientId(clientId)) {
        document.getElementById('clientId').parentElement.classList.add('has-error');
        showAlert('El RIF o cédula no tiene un formato válido (Ej: V-12345678 o J-12345678-9).', 'warning');
        isValid = false;
    }
    if (!clientAddress) {
        document.getElementById('clientAddress').parentElement.classList.add('has-error');
        showAlert('La dirección del cliente es obligatoria.', 'warning');
        isValid = false;
    }
    if (clientPhone && !validatePhone(clientPhone)) {
        document.getElementById('clientPhone').parentElement.classList.add('has-error');
        showAlert('El teléfono debe tener un formato válido (Ej: +584123456789).', 'warning');
        isValid = false;
    }
    if (!clientEmails) {
        document.getElementById('clientEmails').parentElement.classList.add('has-error');
        showAlert('El correo electrónico del cliente es obligatorio.', 'warning');
        isValid = false;
    } else {
        // Validar formato de los correos electrónicos
        const emails = clientEmails.split(',').map(email => email.trim());
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const invalidEmails = emails.filter(email => !emailRegex.test(email));
        if (invalidEmails.length > 0) {
            document.getElementById('clientEmails').parentElement.classList.add('has-error');
            showAlert(`Los siguientes correos no tienen un formato válido: ${invalidEmails.join(', ')}`, 'warning');
            isValid = false;
        }
    }

    // Validar información de la factura
    if (!invoiceDate) {
        document.getElementById('invoiceDate').parentElement.classList.add('has-error');
        showAlert('La fecha de emisión es obligatoria.', 'warning');
        isValid = false;
    }
    if (!docType) {
        document.getElementById('docType').parentElement.classList.add('has-error');
        showAlert('Selecciona un tipo de documento.', 'warning');
        isValid = false;
    }
    if (!paymentMethod) {
        document.getElementById('paymentMethod').parentElement.classList.add('has-error');
        showAlert('Selecciona un método de pago.', 'warning');
        isValid = false;
    }

    // Validar ítems
    if (rows.length === 0 || !rows[0].querySelector('.item-description').value) {
        showAlert('Debes agregar al menos un artículo válido.', 'warning');
        isValid = false;
    }

    try {
        calculateItemTotals(); // Esto lanzará un error si los ítems son inválidos
    } catch (error) {
        isValid = false;
    }

    return isValid;
}
    /**
     * Agrega un nuevo ítem al formulario.
     */
    function addItem() {
        const itemsTableBody = document.getElementById('itemsTableBody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" class="item-description" placeholder="Descripción del artículo" required></td>
            <td><input type="number" class="item-quantity" min="1" value="1" required></td>
            <td><input type="number" step="0.01" class="item-price" min="0" value="0.00" placeholder="Precio en Bs." required></td>
            <td class="item-subtotal">0.00</td>
            <td><button class="btn-secondary remove-item">X</button></td>
        `;
        itemsTableBody.appendChild(newRow);

        // Añadir event listeners a los nuevos campos
        newRow.querySelector('.item-quantity').addEventListener('input', updateSummary);
        newRow.querySelector('.item-price').addEventListener('input', updateSummary);
        newRow.querySelector('.item-description').addEventListener('input', updateSummary);
        newRow.querySelector('.remove-item').addEventListener('click', function() {
            this.closest('tr').remove();
            updateSummary();
        });

        updateSummary();
        newRow.querySelector('.item-description').focus();
    }

    /**
     * Cancela el formulario y regresa a la lista de facturas.
     */
    function cancelInvoice() {
        document.getElementById('invoiceList').classList.remove('hidden');
        document.getElementById('invoiceForm').classList.add('hidden');
        document.querySelectorAll('.has-error').forEach(el => el.classList.remove('has-error'));
        updateDashboardStats();
    }

    /**
     * Genera el número de control para una nueva factura.
     * @param {string} docType - Tipo de documento (factura, nota_credito, nota_debito).
     * @returns {string} - Número de control generado.
     */
    function generateControlNumber(docType) {
        const lastDocNumbers = JSON.parse(localStorage.getItem('lastDocNumbers') || '{}');
        let lastNumber = lastDocNumbers[docType] || 0;
        lastNumber += 1;
        lastDocNumbers[docType] = lastNumber;
        localStorage.setItem('lastDocNumbers', JSON.stringify(lastDocNumbers));
        localStorage.setItem('lastControlNumber', lastNumber.toString());
        return `${lastNumber.toString().padStart(8, '0')}`;
    }

   /**
 * Genera un objeto con los datos de la factura para guardarla o previsualizarla.
 * @returns {object} - Datos de la factura.
 */
function getInvoiceFormData() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || !currentUser.email) {
        console.error('Error: No se encontró el usuario actual en localStorage.');
        showAlert('Error: No se pudo identificar al usuario actual. Por favor, inicia sesión nuevamente.', 'danger');
        return null;
    }

    const subtotal = calculateItemTotals();
    const { iva, igtf, specialTax, total } = calculateTaxesAndTotal(subtotal);

    return {
        id: Date.now().toString(),
        sellerId: currentUser.email,
        sellerName: currentUser.companyName,
        sellerRif: currentUser.rif,
        sellerAddress: currentUser.address,
        sellerPhone: currentUser.phone,
        clientName: document.getElementById('clientName').value.trim(),
        clientId: document.getElementById('clientId').value.trim(),
        clientAddress: document.getElementById('clientAddress').value.trim(),
        clientPhone: document.getElementById('clientPhone').value.trim(),
        date: document.getElementById('invoiceDate').value,
        docType: document.getElementById('docType').value,
        operationCode: document.getElementById('operationCode').value.trim() || 'N/A',
        paymentMethod: document.getElementById('paymentMethod').value,
        notes: document.getElementById('invoiceNotes').value.trim(),
        items: Array.from(document.querySelectorAll('#itemsTableBody tr')).map(row => ({
            description: row.querySelector('.item-description').value,
            quantity: parseFloat(row.querySelector('.item-quantity').value),
            price: parseFloat(row.querySelector('.item-price').value),
            subtotal: parseFloat(row.querySelector('.item-subtotal').textContent.replace(' Bs.', '').replace(',', ''))
        })),
        subtotal: subtotal,
        iva: iva,
        igtf: igtf,
        specialTax: specialTax,
        total: total,
        controlNumber: generateControlNumber(document.getElementById('docType').value),
        totalUSD: (document.getElementById('paymentMethod').value.includes('usd')) ? total / 40 : 0 // Tipo de cambio 40 Bs./USD
    };
}
    /**
     * Muestra una previsualización de la factura desde el formulario.
     */
    function previewInvoice() {
        if (!validateForm()) {
            showAlert('Por favor, corrige los errores en el formulario antes de previsualizar.', 'danger');
            return;
        }

        const invoice = getInvoiceFormData();
        const previewContent = `
            <h3>Previsualización de ${invoice.docType === 'factura' ? 'Factura' : invoice.docType === 'nota_credito' ? 'Nota de Crédito' : 'Nota de Débito'} #${invoice.controlNumber}</h3>
            <p><strong>Emisor:</strong> ${invoice.sellerName} (RIF: ${invoice.sellerRif})</p>
            <p><strong>Cliente:</strong> ${invoice.clientName} (RIF/Cédula: ${invoice.clientId})</p>
            <p><strong>Fecha:</strong> ${formatDate(invoice.date)}</p>
            <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="border: 1px solid #ddd; padding: 8px;">Descripción</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Cantidad</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Precio</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    ${invoice.items.map(item => `
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px;">${item.description}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${item.quantity}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(item.price)}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(item.subtotal)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <p><strong>Subtotal:</strong> ${formatCurrency(invoice.subtotal)}</p>
            <p><strong>IVA (16%):</strong> ${formatCurrency(invoice.iva)}</p>
            <p><strong>IGTF (3%):</strong> ${formatCurrency(invoice.igtf)}</p>
            <p><strong>Retención Especial:</strong> ${formatCurrency(invoice.specialTax)}</p>
            <p><strong>Total:</strong> ${formatCurrency(invoice.total)}</p>
            ${invoice.totalUSD > 0 ? `<p><strong>Total USD:</strong> ${formatCurrency(invoice.totalUSD)}</p>` : ''}
            <p><strong>Notas:</strong> ${invoice.notes || 'Sin notas'}</p>
        `;

        // Mostrar en un modal básico (estilizado)
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.background = 'rgba(0,0,0,0.5)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';
        modal.innerHTML = `
            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 80%; max-height: 80%; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
                ${previewContent}
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-secondary" style="background: #6c757d;" onclick="this.closest('div[style*=\"position: fixed\"]').remove()">Cerrar</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

 /**
 * Guarda la factura en localStorage.
 */
function saveInvoice() {
    if (!validateForm()) {
        showAlert('Por favor, corrige los errores en el formulario.', 'danger');
        return;
    }

    const invoiceLimit = parseInt(localStorage.getItem('invoiceLimit') || '100');
    if (invoiceLimit <= 0) {
        showAlert('No tienes facturas disponibles. Por favor, compra más facturas.', 'danger');
        return;
    }

    const invoice = getInvoiceFormData();
    console.log('Saving Invoice:', invoice); // Depuración

    let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
    invoices.push(invoice);
    localStorage.setItem('invoices', JSON.stringify(invoices));
    localStorage.setItem('invoiceLimit', (invoiceLimit - 1).toString());

    showAlert('Factura generada exitosamente.', 'success');
    loadInvoices();
    cancelInvoice();
    updateDashboardStats();
}

    const invoice = getInvoiceFormData();

    let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
    invoices.push(invoice);
    localStorage.setItem('invoices', JSON.stringify(invoices));
    localStorage.setItem('invoiceLimit', (invoiceLimit - 1).toString());

    showAlert('Factura generada exitosamente.', 'success');
    loadInvoices();
    cancelInvoice();
    updateDashboardStats();
}
        const invoice = getInvoiceFormData();

        let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
        invoices.push(invoice);
        localStorage.setItem('invoices', JSON.stringify(invoices));
        localStorage.setItem('invoiceLimit', (invoiceLimit - 1).toString());

        showAlert('Factura generada exitosamente.', 'success');
        loadInvoices();
        cancelInvoice();
        updateDashboardStats();
    }

/**
 * Carga las facturas en la tabla de historial.
 */
function loadInvoices() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
    const userInvoices = invoices.filter(invoice => invoice.sellerId === currentUser.email);
    const tbody = document.getElementById('invoicesTableBody');
    tbody.innerHTML = '';

    // Depuración: Verificar datos
    console.log('Current User:', currentUser);
    console.log('All Invoices:', invoices);
    console.log('User Invoices:', userInvoices);

    if (userInvoices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px;">No hay facturas emitidas.</td></tr>';
        return;
    }

    // Ordenar facturas por controlNumber de forma descendente
    userInvoices.sort((a, b) => parseInt(b.controlNumber) - parseInt(a.controlNumber));

    userInvoices.forEach(invoice => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${invoice.controlNumber}</td>
            <td>${formatDate(invoice.date)}</td>
            <td>${invoice.clientName}</td>
            <td>${formatCurrency(invoice.subtotal)}</td>
            <td>${formatCurrency(invoice.iva)}</td>
            <td>${formatCurrency(invoice.igtf)}</td>
            <td>${formatCurrency(invoice.total)}</td>
            <td>${invoice.totalUSD > 0 ? formatCurrency(invoice.totalUSD) : 'N/A'}</td>
            <td>${invoice.docType === 'factura' ? 'Factura' : invoice.docType === 'nota_credito' ? 'Nota de Crédito' : 'Nota de Débito'}</td>
            <td>${invoice.operationCode || 'N/A'}</td>
            <td>
                <button class="btn btn-secondary view-invoice" data-id="${invoice.id}">Ver</button>
                <button class="btn btn-secondary print-invoice" data-id="${invoice.id}">Imprimir</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    document.querySelectorAll('.view-invoice').forEach(btn => {
        btn.addEventListener('click', viewInvoice);
    });
    document.querySelectorAll('.print-invoice').forEach(btn => {
        btn.addEventListener('click', printInvoice);
    });

    // Actualizar las estadísticas después de cargar las facturas
    updateDashboardStats();
}

    // Ordenar facturas por controlNumber de forma descendente
    userInvoices.sort((a, b) => parseInt(b.controlNumber) - parseInt(a.controlNumber));

    userInvoices.forEach(invoice => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${invoice.controlNumber}</td>
            <td>${formatDate(invoice.date)}</td>
            <td>${invoice.clientName}</td>
            <td>${formatCurrency(invoice.subtotal)}</td>
            <td>${formatCurrency(invoice.iva)}</td>
            <td>${formatCurrency(invoice.igtf)}</td>
            <td>${formatCurrency(invoice.total)}</td>
            <td>${invoice.totalUSD > 0 ? formatCurrency(invoice.totalUSD) : 'N/A'}</td>
            <td>${invoice.docType === 'factura' ? 'Factura' : invoice.docType === 'nota_credito' ? 'Nota de Crédito' : 'Nota de Débito'}</td>
            <td>${invoice.operationCode || 'N/A'}</td>
            <td>
                <button class="btn btn-secondary view-invoice" data-id="${invoice.id}">Ver</button>
                <button class="btn btn-secondary print-invoice" data-id="${invoice.id}">Imprimir</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    document.querySelectorAll('.view-invoice').forEach(btn => {
        btn.addEventListener('click', viewInvoice);
    });
    document.querySelectorAll('.print-invoice').forEach(btn => {
        btn.addEventListener('click', printInvoice);
    });

    // Actualizar las estadísticas después de cargar las facturas
    updateDashboardStats();
}

    /**
     /**
 * Muestra un modal avanzado para la vista previa de una factura.
 * @param {object} invoice - Datos de la factura a previsualizar.
 */
function showInvoicePreview(invoice) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.background = 'rgba(0,0,0,0.5)';
    modal.style.display = 'flex';
    modal.style.justifyContent = 'center';
    modal.style.alignItems = 'center';
    modal.style.zIndex = '1000';

    const previewContent = `
        <div class="modal-content" style="background: white; padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90%; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
            <h3>${invoice.docType === 'factura' ? 'Factura' : invoice.docType === 'nota_credito' ? 'Nota de Crédito' : 'Nota de Débito'} #${invoice.controlNumber}</h3>
            <p><strong>Emisor:</strong> ${invoice.sellerName} (RIF: ${invoice.sellerRif})</p>
            <p><strong>Cliente:</strong> ${invoice.clientName} (RIF/Cédula: ${invoice.clientId})</p>
            <p><strong>Fecha:</strong> ${formatDate(invoice.date)}</p>
            <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                <thead>
                    <tr style="background: #2968c8; color: white;">
                        <th style="border: 1px solid #ddd; padding: 8px;">Descripción</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Cantidad</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Precio</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    ${invoice.items.map(item => `
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px;">${item.description}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${item.quantity}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(item.price)}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(item.subtotal)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div style="margin-top: 20px;">
                <p><strong>Subtotal:</strong> ${formatCurrency(invoice.subtotal)}</p>
                <p><strong>IVA (16%):</strong> ${formatCurrency(invoice.iva)}</p>
                <p><strong>IGTF (3%):</strong> ${formatCurrency(invoice.igtf)}</p>
                <p><strong>Retención Especial:</strong> ${formatCurrency(invoice.specialTax)}</p>
                <p><strong>Total:</strong> ${formatCurrency(invoice.total)}</p>
                ${invoice.totalUSD > 0 ? `<p><strong>Total USD:</strong> ${formatCurrency(invoice.totalUSD)}</p>` : ''}
                <p><strong>Notas:</strong> ${invoice.notes || 'Sin notas'}</p>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary close-modal">Cerrar</button>
                <button class="btn print-modal">Imprimir</button>
            </div>
        </div>
    `;
    /**
 * Muestra una previsualización de la factura desde el formulario.
 */
function previewInvoice() {
    if (!validateForm()) {
        showAlert('Por favor, corrige los errores en el formulario antes de previsualizar.', 'danger');
        return;
    }

    const invoice = getInvoiceFormData();
    const previewContent = `
        <h3>Previsualización de ${invoice.docType === 'factura' ? 'Factura' : invoice.docType === 'nota_credito' ? 'Nota de Crédito' : 'Nota de Débito'} #${invoice.controlNumber}</h3>
        <p><strong>Emisor:</strong> ${invoice.sellerName} (RIF: ${invoice.sellerRif})</p>
        <p><strong>Cliente:</strong> ${invoice.clientName} (RIF/Cédula: ${invoice.clientId})</p>
        <p><strong>Fecha:</strong> ${formatDate(invoice.date)}</p>
        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
            <thead>
                <tr style="background: #f8f9fa;">
                    <th style="border: 1px solid #ddd; padding: 8px;">Descripción</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Cantidad</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Precio</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Subtotal</th>
                </tr>
            </thead>
            <tbody>
                ${invoice.items.map(item => `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">${item.description}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${item.quantity}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(item.price)}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(item.subtotal)}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        <p><strong>Subtotal:</strong> ${formatCurrency(invoice.subtotal)}</p>
        <p><strong>IVA (16%):</strong> ${formatCurrency(invoice.iva)}</p>
        <p><strong>IGTF (3%):</strong> ${formatCurrency(invoice.igtf)}</p>
        <p><strong>Retención Especial:</strong> ${formatCurrency(invoice.specialTax)}</p>
        <p><strong>Total:</strong> ${formatCurrency(invoice.total)}</p>
        ${invoice.totalUSD > 0 ? `<p><strong>Total USD:</strong> ${formatCurrency(invoice.totalUSD)}</p>` : ''}
        <p><strong>Notas:</strong> ${invoice.notes || 'Sin notas'}</p>
    `;

    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.background = 'rgba(0,0,0,0.5)';
    modal.style.display = 'flex';
    modal.style.justifyContent = 'center';
    modal.style.alignItems = 'center';
    modal.style.zIndex = '1000';
    modal.innerHTML = `
        <div class="modal-content">
            ${previewContent}
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary close-modal">Cerrar</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
}
    /**
     * Imprime la factura (abre la vista de impresión).
     * @param {Event} event - Evento del botón "Imprimir".
     */
    function printInvoice(event) {
        const invoiceId = event.target.getAttribute('data-id');
        const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
        const invoice = invoices.find(i => i.id === invoiceId);

        if (invoice) {
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`
                <html>
                <head>
                    <title>${invoice.docType === 'factura' ? 'Factura' : invoice.docType === 'nota_credito' ? 'Nota de Crédito' : 'Nota de Débito'} #${invoice.controlNumber}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { text-align: center; color: #2968c8; }
                        .invoice-header { margin-bottom: 20px; }
                        .invoice-header p { margin: 5px 0; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background: #f8f9fa; font-weight: bold; }
                        .totals { margin-top: 20px; }
                        .totals p { margin: 5px 0; }
                    </style>
                </head>
                <body>
                    <h1>${invoice.docType === 'factura' ? 'Factura' : invoice.docType === 'nota_credito' ? 'Nota de Crédito' : 'Nota de Débito'} #${invoice.controlNumber}</h1>
                    <div class="invoice-header">
                        <p><strong>Emisor:</strong> ${invoice.sellerName} (RIF: ${invoice.sellerRif})</p>
                        <p><strong>Dirección:</strong> ${invoice.sellerAddress}</p>
                        <p><strong>Teléfono:</strong> ${invoice.sellerPhone}</p>
                        <p><strong>Cliente:</strong> ${invoice.clientName} (RIF/Cédula: ${invoice.clientId})</p>
                        <p><strong>Dirección Cliente:</strong> ${invoice.clientAddress}</p>
                        <p><strong>Teléfono Cliente:</strong> ${invoice.clientPhone || 'N/A'}</p>
                        <p><strong>Fecha:</strong> ${formatDate(invoice.date)}</p>
                        <p><strong>Método de Pago:</strong> ${invoice.paymentMethod.replace('_', ' ').toUpperCase()}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Descripción</th>
                                <th>Cantidad</th>
                                <th>Precio</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.items.map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>${item.quantity}</td>
                                    <td>${formatCurrency(item.price)}</td>
                                    <td>${formatCurrency(item.subtotal)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="totals">
                        <p><strong>Subtotal:</strong> ${formatCurrency(invoice.subtotal)}</p>
                        <p><strong>IVA (16%):</strong> ${formatCurrency(invoice.iva)}</p>
                        <p><strong>IGTF (3%):</strong> ${formatCurrency(invoice.igtf)}</p>
                        <p><strong>Retención Especial:</strong> ${formatCurrency(invoice.specialTax)}</p>
                        <p><strong>Total:</strong> ${formatCurrency(invoice.total)}</p>
                        ${invoice.totalUSD > 0 ? `<p><strong>Total USD:</strong> ${formatCurrency(invoice.totalUSD)}</p>` : ''}
                        <p><strong>Notas:</strong> ${invoice.notes || 'Sin notas'}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    }

    // Configuración de event listeners para el formulario
    document.getElementById('addItemBtn').addEventListener('click', addItem);
    document.getElementById('cancelInvoiceBtn').addEventListener('click', cancelInvoice);
    document.getElementById('saveInvoiceBtn').addEventListener('click', saveInvoice);
    document.getElementById('previewInvoiceBtn').addEventListener('click', previewInvoice);

    // Actualizar resumen al cambiar valores
    document.getElementById('paymentMethod').addEventListener('change', updateSummary);
    document.querySelectorAll('.item-quantity, .item-price, .item-description').forEach(input => {
        input.addEventListener('input', updateSummary);
    });

    // Cargar facturas al iniciar o cambiar pestaña
    switchTab('Invoices');
    loadInvoices();

    // ===========================================================================
    // ESTILOS ADICIONALES - PARTE 2
    // ===========================================================================
    // Agregamos estilos adicionales al DOM para mejorar la apariencia del historial
    // y el formulario.
    const styleSheet = document.createElement('style');
    styleSheet.innerHTML = `
        /* Estilos adicionales para la tabla de historial */
        #invoicesTable {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #invoicesTable th {
            background: #2968c8;
            color: white;
            padding: 15px;
            text-align: center;
            border-right: 1px solid #1d4f9e;
        }
        #invoicesTable th:last-child {
            border-right: none;
        }
        #invoicesTable td {
            padding: 12px;
            text-align: center;
            transition: background 0.3s ease;
        }
        #invoicesTable tr:hover {
            background: #f1f8ff;
        }
        #invoicesTable tr:nth-child(even) {
            background: #f8f9fa;
        }
        #invoicesTable .btn {
            margin: 0 5px;
            padding: 8px 12px;
            font-size: 14px;
        }

        /* Estilos para el formulario */
        .invoice-form .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fafafa;
            transition: box-shadow 0.3s ease;
        }
        .invoice-form .form-section:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .items-table th {
            background: #2968c8;
            color: white;
            padding: 10px;
        }
        .items-table td {
            padding: 5px;
        }
        .items-table input {
            border-radius: 4px;
            padding: 8px;
        }
        .summary-table {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .summary-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .summary-table tr:last-child td {
            background: #2968c8;
            color: white;
            font-weight: bold;
        }
        .action-buttons .btn {
            min-width: 120px;
        }

        /* Animación para filas de ítems al agregar */
        #itemsTableBody tr {
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Estilos para el modal de previsualización */
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .modal-content h3 {
            color: #2968c8;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .modal-content p {
            margin: 8px 0;
        }
    `;
    document.head.appendChild(styleSheet);

    // ===========================================================================
    // FIN DE LA PARTE 2 (EXTENDIDA) (~1000 líneas)
    // ===========================================================================
    // Esta parte incluye la lógica completa del formulario, historial de facturas,
    // validaciones avanzadas, previsualización mejorada, y estilos adicionales.
    // Ahora estamos listos para proceder con la Parte 3.
    // ===========================================================================
</script>
<!-- Continuación de las Partes 1 y 2: Añadir este bloque <script> al final del archivo -->
<script>
    // ===========================================================================
    // FUNCIONES Y LÓGICA - PARTE 3
    // ===========================================================================
    // Esta sección incluye la funcionalidad de las pestañas "Clientes" y "Mi Perfil",
    // un modal avanzado para vista previa, manejo del límite de facturas, y ajustes
    // finales de responsividad y pruebas.
    // ===========================================================================

    /**
     * Carga la lista de clientes en la tabla.
     */
    function loadClients() {
        const clients = JSON.parse(localStorage.getItem('clients') || '[]');
        const tbody = document.getElementById('clientsTableBody');
        tbody.innerHTML = '';

        if (clients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No hay clientes registrados.</td></tr>';
            return;
        }

        clients.forEach(client => {
            const row = document.createElement('tr');
            const invoiceCount = (JSON.parse(localStorage.getItem('invoices') || '[]')).filter(invoice => invoice.clientId === client.id).length;
            row.innerHTML = `
                <td>${client.name}</td>
                <td>${client.id}</td>
                <td>${client.address}</td>
                <td>${client.phone || 'N/A'}</td>
                <td>${invoiceCount}</td>
                <td>
                    <button class="btn btn-secondary edit-client" data-id="${client.id}">Editar</button>
                    <button class="btn btn-danger delete-client" data-id="${client.id}">Eliminar</button>
                </td>
            `;
            tbody.appendChild(row);
        });

        document.querySelectorAll('.edit-client').forEach(btn => btn.addEventListener('click', editClient));
        document.querySelectorAll('.delete-client').forEach(btn => btn.addEventListener('click', deleteClient));
    }

    /**
     * Muestra el formulario para agregar o editar un cliente.
     * @param {object} [client] - Cliente a editar (opcional).
     */
    function showClientForm(client = null) {
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.background = 'rgba(0,0,0,0.5)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';

        const formContent = `
            <div class="modal-content" style="background: white; padding: 20px; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
                <h3>${client ? 'Editar Cliente' : 'Agregar Nuevo Cliente'}</h3>
                <div class="form-group">
                    <label for="clientFormName">Nombre o Razón Social*</label>
                    <input type="text" id="clientFormName" value="${client ? client.name : ''}" required>
                </div>
                <div class="form-group">
                    <label for="clientFormId">Cédula o RIF*</label>
                    <input type="text" id="clientFormId" value="${client ? client.id : ''}" placeholder="Ej: V-12345678 o J-12345678-9" required>
                </div>
                <div class="form-group">
                    <label for="clientFormAddress">Dirección*</label>
                    <input type="text" id="clientFormAddress" value="${client ? client.address : ''}" required>
                </div>
                <div class="form-group">
                    <label for="clientFormPhone">Teléfono</label>
                    <input type="text" id="clientFormPhone" value="${client ? client.phone : ''}">
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="this.closest('div[style*=\"position: fixed\"]').remove()">Cancelar</button>
                    <button class="btn btn-success" id="saveClientBtn">${client ? 'Guardar Cambios' : 'Agregar Cliente'}</button>
                </div>
            </div>
        `;
        modal.innerHTML = formContent;
        document.body.appendChild(modal);

        const saveClientBtn = modal.querySelector('#saveClientBtn');
        saveClientBtn.addEventListener('click', () => {
            const name = document.getElementById('clientFormName').value.trim();
            const id = document.getElementById('clientFormId').value.trim();
            const address = document.getElementById('clientFormAddress').value.trim();
            const phone = document.getElementById('clientFormPhone').value.trim();

            if (!name || !validateClientId(id) || !address) {
                showAlert('Por favor, completa todos los campos obligatorios y verifica el RIF/Cédula.', 'warning');
                return;
            }
            if (phone && !validatePhone(phone)) {
                showAlert('El teléfono debe tener un formato válido (Ej: +584123456789).', 'warning');
                return;
            }

            let clients = JSON.parse(localStorage.getItem('clients') || '[]');
            if (client) {
                const index = clients.findIndex(c => c.id === client.id);
                clients[index] = { id, name, address, phone };
            } else {
                clients.push({ id, name, address, phone });
            }
            localStorage.setItem('clients', JSON.stringify(clients));
            modal.remove();
            loadClients();
            showAlert(`${client ? 'Cliente actualizado' : 'Cliente agregado'} exitosamente.`, 'success');
        });
    }

    /**
     * Edita un cliente existente.
     * @param {Event} event - Evento del botón "Editar".
     */
    function editClient(event) {
        const clientId = event.target.getAttribute('data-id');
        const clients = JSON.parse(localStorage.getItem('clients') || '[]');
        const client = clients.find(c => c.id === clientId);
        showClientForm(client);
    }

    /**
     * Elimina un cliente.
     * @param {Event} event - Evento del botón "Eliminar".
     */
    function deleteClient(event) {
        if (confirm('¿Estás seguro de eliminar este cliente? Esta acción no se puede deshacer.')) {
            const clientId = event.target.getAttribute('data-id');
            let clients = JSON.parse(localStorage.getItem('clients') || '[]');
            clients = clients.filter(c => c.id !== clientId);
            localStorage.setItem('clients', JSON.stringify(clients));
            loadClients();
            showAlert('Cliente eliminado exitosamente.', 'success');
        }
    }

    /**
/**
 * Carga y permite editar la información del perfil de la empresa.
 */
function loadProfile() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    document.getElementById('profileCompanyName').value = currentUser.companyName;
    document.getElementById('profileRif').value = currentUser.rif;
    document.getElementById('profileAddress').value = currentUser.address;
    document.getElementById('profilePhone').value = currentUser.phone || '';
    document.getElementById('profileEmail').value = currentUser.email; // Asegurarse de que el email se muestre
    document.getElementById('profileTaxStatus').textContent = currentUser.isSpecialContributor ? 'Contribuyente Especial' : 'Normal';

    const editProfileBtn = document.createElement('button');
    editProfileBtn.className = 'btn';
    editProfileBtn.textContent = 'Editar Perfil';
    editProfileBtn.style.marginTop = '20px';
    const existingBtn = document.getElementById('contentProfile').querySelector('.btn');
    if (existingBtn) existingBtn.remove(); // Evitar duplicados
    document.getElementById('contentProfile').appendChild(editProfileBtn);

    editProfileBtn.addEventListener('click', () => {
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.background = 'rgba(0,0,0,0.5)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';

        const formContent = `
            <div class="modal-content" style="background: white; padding: 20px; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
                <h3>Editar Perfil de la Empresa</h3>
                <div class="form-group">
                    <label for="editCompanyName">Nombre o Razón Social*</label>
                    <input type="text" id="editCompanyName" value="${currentUser.companyName}" required>
                </div>
                <div class="form-group">
                    <label for="editRif">RIF*</label>
                    <input type="text" id="editRif" value="${currentUser.rif}" readonly>
                </div>
                <div class="form-group">
                    <label for="editAddress">Dirección Fiscal*</label>
                    <input type="text" id="editAddress" value="${currentUser.address}" required>
                </div>
                <div class="form-group">
                    <label for="editPhone">Teléfono</label>
                    <input type="text" id="editPhone" value="${currentUser.phone || ''}">
                </div>
                <div class="form-group">
                    <label for="editEmail">Correo Electrónico*</label>
                    <input type="email" id="editEmail" value="${currentUser.email}" required>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-secondary close-modal">Cancelar</button>
                    <button class="btn btn-success" id="saveProfileBtn">Guardar Cambios</button>
                </div>
            </div>
        `;
        modal.innerHTML = formContent;
        document.body.appendChild(modal);

        modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
        const saveProfileBtn = modal.querySelector('#saveProfileBtn');
        saveProfileBtn.addEventListener('click', () => {
            const companyName = document.getElementById('editCompanyName').value.trim();
            const rif = document.getElementById('editRif').value.trim();
            const address = document.getElementById('editAddress').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const email = document.getElementById('editEmail').value.trim();

            if (!companyName || !rif || !address || !email || !validateClientId(rif)) {
                showAlert('Por favor, completa todos los campos obligatorios y verifica el RIF.', 'warning');
                return;
            }
            if (phone && !validatePhone(phone)) {
                showAlert('El teléfono debe tener un formato válido (Ej: +584123456789).', 'warning');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            users[userIndex] = {
                ...currentUser,
                companyName,
                rif,
                address,
                phone,
                email
            };
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(users[userIndex]));
            modal.remove();
            loadProfile();
            showAlert('Perfil actualizado exitosamente.', 'success');
            // Actualizar el nombre de usuario en la barra de navegación
            document.getElementById('userDisplayName').textContent = companyName;
        });
    });
}

   /**
 * Muestra un modal avanzado para la vista previa de una factura.
 * @param {object} invoice - Datos de la factura a previsualizar.
 */
function showInvoicePreview(invoice) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.background = 'rgba(0,0,0,0.5)';
    modal.style.display = 'flex';
    modal.style.justifyContent = 'center';
    modal.style.alignItems = 'center';
    modal.style.zIndex = '1000';

    const previewContent = `
        <div class="modal-content" style="background: white; padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90%; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
            <h3>${invoice.docType === 'factura' ? 'Factura' : invoice.docType === 'nota_credito' ? 'Nota de Crédito' : 'Nota de Débito'} #${invoice.controlNumber}</h3>
            <p><strong>Emisor:</strong> ${invoice.sellerName} (RIF: ${invoice.sellerRif})</p>
            <p><strong>Dirección Emisor:</strong> ${invoice.sellerAddress}</p>
            <p><strong>Teléfono Emisor:</strong> ${invoice.sellerPhone || 'N/A'}</p>
            <p><strong>Cliente:</strong> ${invoice.clientName} (RIF/Cédula: ${invoice.clientId})</p>
            <p><strong>Dirección Cliente:</strong> ${invoice.clientAddress}</p>
            <p><strong>Teléfono Cliente:</strong> ${invoice.clientPhone || 'N/A'}</p>
            <p><strong>Fecha:</strong> ${formatDate(invoice.date)}</p>
            <p><strong>Método de Pago:</strong> ${invoice.paymentMethod.replace('_', ' ').toUpperCase()}</p>
            <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                <thead>
                    <tr style="background: #2968c8; color: white;">
                        <th style="border: 1px solid #ddd; padding: 8px;">Descripción</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Cantidad</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Precio</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    ${invoice.items.map(item => `
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px;">${item.description}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${item.quantity}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(item.price)}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(item.subtotal)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div style="margin-top: 20px;">
                <p><strong>Subtotal:</strong> ${formatCurrency(invoice.subtotal)}</p>
                <p><strong>IVA (16%):</strong> ${formatCurrency(invoice.iva)}</p>
                <p><strong>IGTF (3%):</strong> ${formatCurrency(invoice.igtf)}</p>
                <p><strong>Retención Especial:</strong> ${formatCurrency(invoice.specialTax)}</p>
                <p><strong>Total:</strong> ${formatCurrency(invoice.total)}</p>
                ${invoice.totalUSD > 0 ? `<p><strong>Total USD:</strong> ${formatCurrency(invoice.totalUSD)}</p>` : ''}
                <p><strong>Notas:</strong> ${invoice.notes || 'Sin notas'}</p>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary close-modal">Cerrar</button>
                <button class="btn print-modal">Imprimir</button>
            </div>
        </div>
    `;
    modal.innerHTML = previewContent;
    document.body.appendChild(modal);

    modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
    modal.querySelector('.print-modal').addEventListener('click', () => {
        printInvoice({ target: { getAttribute: () => invoice.id } });
        modal.remove();
    });

    // Reemplazar la función viewInvoice para usar este modal
    window.viewInvoice = function(event) {
        const invoiceId = event.target.getAttribute('data-id');
        const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
        const invoice = invoices.find(i => i.id === invoiceId);
        if (invoice) showInvoicePreview(invoice);
    };
}
    /**
     * Simula la compra de más facturas.
     */
    function buyMoreInvoices() {
        const currentInvoiceLimit = parseInt(localStorage.getItem('invoiceLimit') || '100');
        const newLimit = currentInvoiceLimit + 100;
        localStorage.setItem('invoiceLimit', newLimit.toString());
        updateDashboardStats();
        showAlert('Has comprado 100 facturas adicionales. ¡Ahora tienes ' + newLimit + ' facturas disponibles!', 'success');
    }

    /**
     * Ajusta la responsividad avanzada al cambiar el tamaño de la ventana.
     */
    function adjustResponsiveness() {
        const width = window.innerWidth;
        const invoiceForm = document.getElementById('invoiceForm');
        const itemsTable = document.querySelector('.items-table');

        if (width <= 768) {
            invoiceForm.style.gridTemplateColumns = '1fr';
            itemsTable.style.fontSize = '14px';
        } else {
            invoiceForm.style.gridTemplateColumns = '1fr 1fr';
            itemsTable.style.fontSize = '16px';
        }
    }

    // Configuración de event listeners adicionales
    document.getElementById('buyMoreInvoicesBtn').addEventListener('click', buyMoreInvoices);
    document.getElementById('tabClients').addEventListener('click', () => {
        switchTab('Clients');
        loadClients();
    });
    document.getElementById('tabProfile').addEventListener('click', () => {
        switchTab('Profile');
        loadProfile();
    });

    // Cargar datos iniciales al iniciar
    window.addEventListener('load', () => {
        adjustResponsiveness();
        window.addEventListener('resize', adjustResponsiveness);
        loadClients();
        loadProfile();
    });

    // Pruebas básicas
    function runTests() {
        console.log('=== Iniciando pruebas básicas ===');
        // Prueba de formato de moneda
        console.assert(formatCurrency(1234.56) === '1,234.56 Bs.', 'Fallo en formatCurrency');
        console.log('Prueba de formatCurrency: Pasó');

        // Prueba de validación de RIF
        console.assert(validateClientId('J-12345678-9') === true, 'Fallo en validateClientId (RIF)');
        console.assert(validateClientId('V-1234567') === true, 'Fallo en validateClientId (Cédula)');
        console.assert(validateClientId('X-123') === false, 'Fallo en validateClientId (Inválido)');
        console.log('Prueba de validateClientId: Pasó');

        // Prueba de guardado de factura
        const testInvoice = {
            id: 'test123',
            sellerId: 'ejemplo@empresa.com',
            clientName: 'Cliente Test',
            clientId: 'V-12345678',
            clientAddress: 'Test Address',
            date: new Date().toISOString().split('T')[0],
            docType: 'factura',
            items: [{ description: 'Producto', quantity: 2, price: 100 }],
            subtotal: 200,
            iva: 32,
            igtf: 0,
            specialTax: 2,
            total: 234
        };
        let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
        invoices.push(testInvoice);
        localStorage.setItem('invoices', JSON.stringify(invoices));
        loadInvoices();
        console.assert(document.querySelectorAll('#invoicesTableBody tr').length > 0, 'Fallo en carga de facturas');
        console.log('Prueba de guardado y carga de facturas: Pasó');

        console.log('=== Fin de las pruebas ===');
    }
    runTests();

    // ===========================================================================
    // DOCUMENTACIÓN FINAL - PARTE 3
    // ===========================================================================
    // Este dashboard es un sistema de facturación para pequeñas empresas en Venezuela,
    // diseñado para gestionar facturas, clientes y perfiles de empresa. Incluye:
    // - Formulario de facturas con cálculo de IVA (16%), IGTF (3% para USD), y
    //   retención especial (1% para contribuyentes especiales).
    // - Historial de facturas con columnas personalizadas y botones de acción.
    // - Gestión de clientes con CRUD básico.
    // - Perfil editable con información de la empresa.
    // - Modal para vista previa de facturas y funcionalidad de impresión.
    // - Límite de facturas con opción de compra simulada.
    // - Diseño responsivo y pruebas básicas.
    //
    // Total de líneas aproximadas: 3000 (1000 por parte).
    // Fecha de creación: 07/03/2025.
    // Autor: Grok 3 (xAI).
    // ===========================================================================
</script>
