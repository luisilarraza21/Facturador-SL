<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FacturaML - Dashboard</title>
    <style>
        /* ===========================================================================
         * ESTILOS GENERALES
         * ===========================================================================
         * Combinación de estilos del Código 1 (modernos y completos) y Código 2 (limpios y claros).
         * Paleta de colores: azul (#2968c8), amarillo (#ffe600).
         * =========================================================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .navbar {
            background-color: #ffe600;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }
        .navbar:hover {
            background-color: #e6cc00;
        }
        .logo {
            font-weight: bold;
            font-size: 24px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .nav-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-info {
            margin-right: 15px;
            font-size: 16px;
            color: #444;
            font-style: italic;
        }
        .logout-btn {
            background: #2968c8;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .logout-btn:hover {
            background: #1d4f9e;
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #ddd;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .dashboard-title {
            font-size: 24px;
            font-weight: bold;
            color: #2968c8;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 4px 4px 0 0;
        }
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab:hover {
            background: #e9ecef;
            border-bottom-color: #ccc;
        }
        .tab.active {
            border-bottom: 3px solid #2968c8;
            font-weight: bold;
            color: #2968c8;
            background: #fff;
        }

        .tab-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
        }

        .btn {
            background: #2968c8;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: #1d4f9e;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }

        .summary-box {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .summary-card {
            flex: 1;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .summary-card h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #555;
        }
        .summary-card p {
            font-size: 20px;
            font-weight: bold;
            color: #2968c8;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #2968c8;
            color: white;
            font-weight: 600;
            text-align: center;
        }
        tr:hover {
            background: #f1f3f5;
        }
        .currency-usd {
            color: #666;
            font-size: 0.9em;
        }

        .invoice-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fafafa;
        }
        .section-title {
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            color: #333;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2968c8;
            box-shadow: 0 0 5px rgba(41, 104, 200, 0.3);
        }
        .items-table input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .items-table button {
            width: 100%;
            padding: 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .items-table button:hover {
            background: #c82333;
        }
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .summary-table {
            width: 50%;
            margin-left: auto;
            margin-top: 20px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .summary-table td {
            padding: 8px 15px;
        }
        .summary-table tr:last-child {
            font-weight: bold;
            font-size: 18px;
            background: #e9ecef;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 4px;
            z-index: 1001;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: opacity 0.5s ease;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .alert-info {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }
        .has-error input, .has-error select {
            border-color: #dc3545 !important;
            background-color: #fff5f5;
        }

        /* Estilos para el modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .modal-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .modal-body th, .modal-body td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .modal-body th {
            background: #2968c8;
            color: white;
        }
        .modal-footer {
            text-align: right;
        }
        .modal-footer .btn {
            margin-left: 10px;
        }

        /* Media Queries para responsividad */
        @media (max-width: 768px) {
            .summary-box {
                flex-direction: column;
            }
            .invoice-form {
                grid-template-columns: 1fr;
            }
            .action-buttons {
                justify-content: center;
            }
            .summary-table {
                width: 100%;
            }
            .form-row {
                flex-direction: column;
            }
            table th, table td {
                font-size: 14px;
                padding: 8px;
            }
            .modal-content {
                max-width: 95%;
                padding: 10px;
            }
        }
        @media (max-width: 480px) {
            .navbar {
                flex-direction: column;
                gap: 10px;
            }
            .dashboard-title {
                font-size: 20px;
            }
            .tab {
                padding: 10px;
                font-size: 14px;
            }
            .btn {
                padding: 8px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">FacturaML</div>
        <div class="nav-user">
            <div class="user-info" id="userDisplayName">Cargando...</div>
            <button class="logout-btn" id="logoutButton">Cerrar Sesión</button>
        </div>
    </div>

    <div class="container">
        <div class="dashboard-header">
            <div class="dashboard-title">Panel de Control</div>
            <div>
                <button class="btn" id="newInvoiceBtnHeader">Nueva Factura</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" id="tabInvoices">Facturas</div>
            <div class="tab" id="tabClients">Clientes</div>
            <div class="tab" id="tabProfile">Mi Perfil</div>
        </div>

        <div class="tab-content" id="contentInvoices">
            <div id="alertContainer"></div>
            <div id="invoiceList">
                <div class="summary-box">
                    <div class="summary-card">
                        <h3>Total Facturado (Bs.)</h3>
                        <p id="totalInvoicedBs">0,00</p>
                    </div>
                    <div class="summary-card">
                        <h3>Total Facturado (USD)</h3>
                        <p id="totalInvoicedUsd">0,00</p>
                    </div>
                </div>
                <table id="invoicesTable">
                    <thead>
                        <tr>
                            <th>Tipo de Documento</th>
                            <th>Nº Documento</th>
                            <th>Nº Control</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Total (Bs.)</th>
                            <th>Total (USD)</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTableBody">
                        <!-- Rows will be populated dynamically -->
                    </tbody>
                </table>
            </div>
            <div id="invoiceForm" class="invoice-form tab-content hidden">
                <h2>Nueva Factura</h2>
                <div class="form-section">
                    <h3 class="section-title">Información del Cliente</h3>
                    <div class="form-group">
                        <label for="clientName">Nombre o Razón Social*</label>
                        <input type="text" id="clientName" required>
                    </div>
                    <div class="form-group">
                        <label for="clientId">Cédula o RIF*</label>
                        <input type="text" id="clientId" placeholder="Ej: V-12345678 o J-12345678-9" required>
                    </div>
                    <div class="form-group">
                        <label for="clientAddress">Dirección*</label>
                        <input type="text" id="clientAddress" required>
                    </div>
                    <div class="form-group">
                        <label for="clientPhone">Teléfono</label>
                        <input type="text" id="clientPhone">
                    </div>
                    <div class="form-group">
                        <label for="clientEmails">Correos Electrónicos del Cliente (separados por comas)*</label>
                        <input type="text" id="clientEmails" placeholder="Ej: cliente1@correo.com, cliente2@correo.com" required>
                    </div>
                </div>
                <div class="form-section">
                    <h3 class="section-title">Información de la Factura</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoiceDate">Fecha de Emisión*</label>
                            <input type="date" id="invoiceDate" required>
                        </div>
                        <div class="form-group">
                            <label for="docType">Tipo de Documento*</label>
                            <select id="docType" required>
                                <option value="">Selecciona...</option>
                                <option value="factura">Factura</option>
                                <option value="nota_credito">Nota de Crédito</option>
                                <option value="nota_debito">Nota de Débito</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="operationCode">Código de Operación</label>
                            <input type="text" id="operationCode" placeholder="Ej: COD-001">
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">Método de Pago*</label>
                            <select id="paymentMethod" required>
                                <option value="">Selecciona...</option>
                                <option value="efectivo_bs">Efectivo (Bs.)</option>
                                <option value="transferencia_bs">Transferencia (Bs.)</option>
                                <option value="efectivo_usd">Efectivo (USD)</option>
                                <option value="transferencia_usd">Transferencia (USD)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="invoiceNotes">Notas</label>
                        <textarea id="invoiceNotes" rows="2"></textarea>
                    </div>
                </div>
                <div class="form-section">
                    <h3 class="section-title">Artículos</h3>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th width="40%">Descripción</th>
                                <th width="15%">Cantidad</th>
                                <th width="20%">Precio Unitario</th>
                                <th width="20%">Subtotal</th>
                                <th width="5%"></th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <tr>
                                <td><input type="text" class="item-description" placeholder="Descripción del artículo" required></td>
                                <td><input type="number" class="item-quantity" min="1" value="1" required></td>
                                <td><input type="number" step="0.01" class="item-price" min="0" value="0.00" placeholder="Precio en Bs." required></td>
                                <td class="item-subtotal">0.00</td>
                                <td><button class="btn-secondary remove-item">X</button></td>
                            </tr>
                        </tbody>
                    </table>
                    <button class="btn" id="addItemBtn">Agregar Artículo</button>
                </div>
                <div class="form-section">
                    <h3 class="section-title">Resumen</h3>
                    <table class="summary-table">
                        <tr>
                            <td>Subtotal:</td>
                            <td class="text-right" id="summarySubtotal">0.00 Bs.</td>
                        </tr>
                        <tr>
                            <td>IVA (16%):</td>
                            <td class="text-right" id="summaryIva">0.00 Bs.</td>
                        </tr>
                        <tr id="igtfRow" style="display: none;">
                            <td>IGTF (3%):</td>
                            <td class="text-right" id="summaryIgtf">0.00 Bs.</td>
                        </tr>
                        <tr id="specialTaxRow" style="display: none;">
                            <td>Retención Especial:</td>
                            <td class="text-right" id="summarySpecialTax">0.00 Bs.</td>
                        </tr>
                        <tr>
                            <td>Total:</td>
                            <td class="text-right" id="summaryTotal">0.00 Bs.</td>
                        </tr>
                    </table>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="cancelInvoiceBtn">Cancelar</button>
                    <button class="btn btn-secondary" id="previewInvoiceBtn">Previsualizar</button>
                    <button class="btn btn-success" id="saveInvoiceBtn">Guardar Factura</button>
                </div>
            </div>
        </div>

        <div class="tab-content hidden" id="contentClients">
            <h3>Mis Clientes</h3>
            <table id="clientsTable">
                <thead>
                    <tr>
                        <th>Nombre/Razón Social</th>
                        <th>Cédula/RIF</th>
                        <th>Dirección</th>
                        <th>Teléfono</th>
                        <th>Facturas Emitidas</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="clientsTableBody">
                    <!-- Rows will be populated dynamically -->
                </tbody>
            </table>
        </div>

        <div class="tab-content hidden" id="contentProfile">
            <h2>Mi Perfil</h2>
            <div class="form-group">
                <label for="profileCompanyName">Nombre o Razón Social</label>
                <input type="text" id="profileCompanyName" readonly>
            </div>
            <div class="form-group">
                <label for="profileRif">RIF</label>
                <input type="text" id="profileRif" readonly>
            </div>
            <div class="form-group">
                <label for="profileAddress">Dirección Fiscal</label>
                <input type="text" id="profileAddress" readonly>
            </div>
            <div class="form-group">
                <label for="profilePhone">Teléfono</label>
                <input type="text" id="profilePhone" readonly>
            </div>
            <div class="form-group">
                <label for="profileEmail">Correo Electrónico</label>
                <input type="email" id="profileEmail" readonly>
            </div>
            <div class="form-group">
                <label>Estatus de Contribuyente</label>
                <p id="profileTaxStatus">Normal</p>
            </div>
            <div style="margin-top: 30px;">
                <h3>Plan de Facturación</h3>
                <div class="alert alert-info">
                    Tienes activado el plan de <strong>Talonario de 100 Facturas</strong>
                </div>
                <div id="lowInvoicesWarning" class="alert alert-warning hidden">
                    Te quedan menos de 10 facturas disponibles. ¡Considera comprar más pronto!
                </div>
                <button class="btn" id="buyMoreInvoicesBtn">Comprar más facturas</button>
            </div>
        </div>
    </div>

    <script>
        // ===========================================================================
        // FUNCIONES COMPLETAS
        // ===========================================================================
        // Combinación de la lógica completa del Código 1 con la claridad y precisión del Código 2.
        // ===========================================================================

        let exchangeRate = 64.74; // Tasa de cambio por defecto

        /**
         * Muestra una alerta temporal en la interfaz.
         * @param {string} message - El mensaje a mostrar.
         * @param {string} type - Tipo de alerta (success, warning, danger, info).
         */
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        /**
         * Formatea un número como moneda.
         * @param {number} amount - El monto a formatear.
         * @returns {string} - El monto formateado con comas.
         */
        function formatCurrency(amount) {
            return amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        /**
         * Formatea una fecha al estilo venezolano.
         * @param {string} dateString - La fecha en formato ISO.
         * @returns {string} - Fecha formateada (dd/mm/yyyy).
         */
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-VE');
        }

        /**
         * Valida el formato de un RIF o cédula venezolana.
         * @param {string} clientId - El RIF o cédula a validar.
         * @returns {boolean} - True si es válido, false si no.
         */
        function validateClientId(clientId) {
            const rifRegex = /^[VEJPG]-[0-9]{8}-[0-9]$/;
            const cedulaRegex = /^[VE]-[0-9]{1,8}$/;
            return rifRegex.test(clientId) || cedulaRegex.test(clientId);
        }

        /**
         * Valida el formato de un teléfono venezolano (opcional).
         * @param {string} phone - El número de teléfono a validar.
         * @returns {boolean} - True si es válido o vacío, false si no.
         */
        function validatePhone(phone) {
            if (!phone) return true;
            const phoneRegex = /^(\+58|0)[0-9]{10}$/;
            return phoneRegex.test(phone);
        }

        /**
         * Valida el formato de correos electrónicos (múltiples, separados por comas).
         * @param {string} emails - Cadena de correos electrónicos.
         * @returns {boolean} - True si son válidos, false si no.
         */
        function validateEmails(emails) {
            if (!emails) return false;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const emailArray = emails.split(',').map(email => email.trim()).filter(email => email.length > 0);
            return emailArray.every(email => emailRegex.test(email));
        }

        /**
         * Simula la obtención de la tasa de cambio del dólar.
         * @returns {Promise<void>}
         */
        async function fetchExchangeRate() {
            try {
                const response = { success: true, rate: 64.74, date: '2025-03-07' };
                if (response.success) {
                    exchangeRate = response.rate;
                    showAlert(`Tasa del dólar BCV (${response.date}): ${exchangeRate} VES/USD`, 'info');
                } else {
                    throw new Error('Fallo al obtener la tasa');
                }
            } catch (error) {
                showAlert('Error al cargar tasa del dólar. Usando valor por defecto.', 'warning');
                exchangeRate = 64.74; // Valor por defecto
            }
        }

        /**
         * Inicializa la aplicación con datos predeterminados si no existen.
         */
        function initializeApp() {
            if (!localStorage.getItem('initialized')) {
                if (!localStorage.getItem('users')) {
                    const users = [{
                        email: 'ejemplo@empresa.com',
                        password: 'password123',
                        companyName: 'Soluciones Laser',
                        rif: 'J-12345678-9',
                        address: 'Av. Principal, Caracas',
                        phone: '+584123456789',
                        isSpecialContributor: true,
                        availableInvoices: 100
                    }];
                    localStorage.setItem('users', JSON.stringify(users));
                }
                if (!localStorage.getItem('invoices')) {
                    localStorage.setItem('invoices', JSON.stringify([]));
                }
                if (!localStorage.getItem('clients')) {
                    localStorage.setItem('clients', JSON.stringify([]));
                }
                if (!localStorage.getItem('lastControlNumber')) {
                    localStorage.setItem('lastControlNumber', '0');
                }
                if (!localStorage.getItem('lastDocNumbers')) {
                    localStorage.setItem('lastDocNumbers', JSON.stringify({ factura: 0, nota_credito: 0, nota_debito: 0 }));
                }
                if (!localStorage.getItem('invoiceLimit')) {
                    localStorage.setItem('invoiceLimit', '100');
                }
                localStorage.setItem('initialized', 'true');
            }
        }

        /**
         * Verifica autenticación y carga datos iniciales.
         */
        document.addEventListener('DOMContentLoaded', async () => {
            initializeApp();
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser || !currentUser.rif || !currentUser.companyName || !currentUser.address) {
                showAlert('Usuario no autenticado o datos incompletos. Redirigiendo al login.', 'danger');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }
            if (!validateClientId(currentUser.rif)) {
                showAlert('RIF inválido. Redirigiendo al login.', 'danger');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }
            document.getElementById('userDisplayName').textContent = currentUser.companyName;
            await fetchExchangeRate();
            if (!exchangeRate || exchangeRate <= 0) {
                showAlert('Tasa de cambio no válida. Los valores en USD pueden no ser precisos.', 'warning');
            }
            setupEventListeners();
            loadInvoices();
            loadClients();
            loadProfile();
        });

        /**
         * Configura los event listeners básicos y adicionales.
         */
        function setupEventListeners() {
            document.getElementById('logoutButton').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });
            document.getElementById('tabInvoices').addEventListener('click', () => {
                switchTab('Invoices');
                loadInvoices();
            });
            document.getElementById('tabClients').addEventListener('click', () => {
                switchTab('Clients');
                loadClients();
            });
            document.getElementById('tabProfile').addEventListener('click', () => {
                switchTab('Profile');
                loadProfile();
            });
            document.getElementById('newInvoiceBtnHeader').addEventListener('click', showInvoiceForm);
            document.getElementById('addItemBtn').addEventListener('click', addItem);
            document.getElementById('cancelInvoiceBtn').addEventListener('click', cancelInvoice);
            document.getElementById('saveInvoiceBtn').addEventListener('click', saveInvoice);
            document.getElementById('previewInvoiceBtn').addEventListener('click', previewInvoice);
            document.getElementById('buyMoreInvoicesBtn').addEventListener('click', buyMoreInvoices);

            // Listeners dinámicos para ítems iniciales
            document.querySelectorAll('.item-quantity, .item-price, .item-description').forEach(input => {
                input.addEventListener('input', updateSummary);
            });
            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('tr').remove();
                    updateSummary();
                });
            });
            document.getElementById('paymentMethod').addEventListener('change', updateSummary);

            // Listeners para clientes
            document.getElementById('contentClients').addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-client')) editClient(e);
                if (e.target.classList.contains('delete-client')) deleteClient(e);
            });
        }

        /**
         * Cambia la pestaña activa en la interfaz.
         * @param {string} tab - Nombre de la pestaña (Invoices, Clients, Profile).
         */
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(tabElement => tabElement.classList.remove('active'));
            document.getElementById(`content${tab}`).classList.remove('hidden');
            document.getElementById(`tab${tab}`).classList.add('active');
        }

        /**
         * Actualiza las estadísticas del dashboard.
         */
        function updateDashboardStats() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const userInvoices = invoices.filter(invoice => invoice.sellerId === currentUser.email);
            const invoiceLimit = parseInt(localStorage.getItem('invoiceLimit') || '100');
            const availableInvoices = Math.max(0, invoiceLimit - userInvoices.length);
            const lowInvoicesWarning = document.getElementById('lowInvoicesWarning');
            if (availableInvoices < 10) {
                lowInvoicesWarning.classList.remove('hidden');
            } else {
                lowInvoicesWarning.classList.add('hidden');
            }
        }

        /**
         * Carga las facturas en la tabla de historial.
         */
        function loadInvoices() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const userInvoices = invoices.filter(invoice => invoice.sellerId === currentUser.email);
            const tbody = document.getElementById('invoicesTableBody');
            let totalInvoicedBs = 0;
            tbody.innerHTML = '';

            if (userInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">No hay facturas emitidas.</td></tr>';
            } else {
                userInvoices.sort((a, b) => parseInt(b.controlNumber) - parseInt(a.controlNumber));
                userInvoices.forEach(invoice => {
                    totalInvoicedBs += invoice.total;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${invoice.docType.charAt(0).toUpperCase() + invoice.docType.slice(1)}</td>
                        <td>${invoice.docNumber}</td>
                        <td>${invoice.controlNumber}</td>
                        <td>${invoice.clientName}</td>
                        <td>${formatDate(invoice.date)}</td>
                        <td>${formatCurrency(invoice.total)}</td>
                        <td class="currency-usd">${formatCurrency(invoice.total / exchangeRate)}</td>
                        <td>
                            <button class="btn btn-secondary view-invoice" data-id="${invoice.id}">Ver</button>
                            <button class="btn btn-secondary print-invoice" data-id="${invoice.id}">Imprimir</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            document.getElementById('totalInvoicedBs').textContent = formatCurrency(totalInvoicedBs);
            document.getElementById('totalInvoicedUsd').textContent = formatCurrency(totalInvoicedBs / exchangeRate);

            document.querySelectorAll('.view-invoice').forEach(btn => btn.addEventListener('click', viewInvoice));
            document.querySelectorAll('.print-invoice').forEach(btn => btn.addEventListener('click', printInvoice));
        }

        /**
         * Muestra el formulario de nueva factura y lo inicializa.
         */
        function showInvoiceForm() {
            const invoiceLimit = parseInt(localStorage.getItem('invoiceLimit') || '100');
            if (invoiceLimit <= 0) {
                showAlert('No tienes facturas disponibles. Por favor, compra más facturas para continuar.', 'danger');
                return;
            }

            document.getElementById('invoiceList').classList.add('hidden');
            document.getElementById('invoiceForm').classList.remove('hidden');

            document.getElementById('clientName').value = '';
            document.getElementById('clientId').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientEmails').value = '';
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('docType').value = 'factura';
            document.getElementById('operationCode').value = '';
            document.getElementById('paymentMethod').value = 'efectivo_bs';
            document.getElementById('invoiceNotes').value = '';

            const itemsTableBody = document.getElementById('itemsTableBody');
            itemsTableBody.innerHTML = `
                <tr>
                    <td><input type="text" class="item-description" placeholder="Descripción del artículo" required></td>
                    <td><input type="number" class="item-quantity" min="1" value="1" required></td>
                    <td><input type="number" step="0.01" class="item-price" min="0" value="0.00" placeholder="Precio en Bs." required></td>
                    <td class="item-subtotal">0.00</td>
                    <td><button class="btn-secondary remove-item">X</button></td>
                </tr>
            `;

            document.getElementById('summarySubtotal').textContent = formatCurrency(0) + ' Bs.';
            document.getElementById('summaryIva').textContent = formatCurrency(0) + ' Bs.';
            document.getElementById('summaryIgtf').textContent = formatCurrency(0) + ' Bs.';
            document.getElementById('summarySpecialTax').textContent = formatCurrency(0) + ' Bs.';
            document.getElementById('summaryTotal').textContent = formatCurrency(0) + ' Bs.';

            document.querySelectorAll('.has-error').forEach(el => el.classList.remove('has-error'));
            document.querySelectorAll('.item-quantity, .item-price, .item-description').forEach(input => {
                input.addEventListener('input', updateSummary);
            });
            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('tr').remove();
                    updateSummary();
                });
            });
            document.getElementById('clientName').focus();
        }

        /**
         * Calcula los subtotales y totales de los ítems en el formulario.
         * @returns {number} - El subtotal total de todos los ítems.
         */
        function calculateItemTotals() {
            const rows = document.querySelectorAll('#itemsTableBody tr');
            let subtotal = 0;
            let hasErrors = false;

            rows.forEach((row, index) => {
                const description = row.querySelector('.item-description').value.trim();
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;

                if (!description) {
                    row.querySelector('.item-description').parentElement.classList.add('has-error');
                    showAlert(`El artículo #${index + 1} necesita una descripción.`, 'warning');
                    hasErrors = true;
                } else {
                    row.querySelector('.item-description').parentElement.classList.remove('has-error');
                }
                if (quantity <= 0) {
                    row.querySelector('.item-quantity').parentElement.classList.add('has-error');
                    showAlert(`El artículo #${index + 1} debe tener una cantidad mayor a 0.`, 'warning');
                    hasErrors = true;
                } else {
                    row.querySelector('.item-quantity').parentElement.classList.remove('has-error');
                }
                if (price <= 0) {
                    row.querySelector('.item-price').parentElement.classList.add('has-error');
                    showAlert(`El artículo #${index + 1} debe tener un precio mayor a 0.`, 'warning');
                    hasErrors = true;
                } else {
                    row.querySelector('.item-price').parentElement.classList.remove('has-error');
                }

                const itemSubtotal = quantity * price;
                row.querySelector('.item-subtotal').textContent = itemSubtotal.toFixed(2);
                subtotal += itemSubtotal;
            });

            if (hasErrors) {
                throw new Error('Errores en los ítems de la factura.');
            }

            return subtotal;
        }

        /**
         * Calcula los impuestos (IVA, IGTF, retención) y el total de la factura.
         * @param {number} subtotal - El subtotal de los ítems.
         * @returns {object} - Objeto con los valores calculados.
         */
        function calculateTaxesAndTotal(subtotal) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const ivaRate = 0.16; // 16% IVA
            const igtfRate = 0.03; // 3% IGTF para pagos en USD
            const specialTaxRate = currentUser.isSpecialContributor ? 0.01 : 0; // 1% para contribuyentes especiales
            const paymentMethod = document.getElementById('paymentMethod').value;

            let iva = subtotal * ivaRate;
            let igtf = (paymentMethod.includes('usd')) ? (subtotal + iva) * igtfRate : 0;
            let specialTax = subtotal * specialTaxRate;

            const total = subtotal + iva + igtf + specialTax;

            return { subtotal, iva, igtf, specialTax, total };
        }

        /**
         * Actualiza el resumen de la factura en la interfaz.
         */
        function updateSummary() {
            try {
                const subtotal = calculateItemTotals();
                const { iva, igtf, specialTax, total } = calculateTaxesAndTotal(subtotal);

                document.getElementById('summarySubtotal').textContent = formatCurrency(subtotal) + ' Bs.';
                document.getElementById('summaryIva').textContent = formatCurrency(iva) + ' Bs.';
                document.getElementById('summaryIgtf').textContent = formatCurrency(igtf) + ' Bs.';
                document.getElementById('summarySpecialTax').textContent = formatCurrency(specialTax) + ' Bs.';
                document.getElementById('summaryTotal').textContent = formatCurrency(total) + ' Bs.';

                document.getElementById('igtfRow').style.display = igtf > 0 ? 'table-row' : 'none';
                document.getElementById('specialTaxRow').style.display = specialTax > 0 ? 'table-row' : 'none';
            } catch (error) {
                console.error('Error al actualizar el resumen:', error.message);
                showAlert('Error al calcular los totales. Revisa los ítems.', 'danger');
            }
        }

        /**
         * Valida el formulario antes de guardarlo o previsualizarlo.
         * @returns {boolean} - True si es válido, false si no.
         */
        function validateForm() {
            let isValid = true;
            document.querySelectorAll('.has-error').forEach(el => el.classList.remove('has-error'));

            const clientName = document.getElementById('clientName').value.trim();
            const clientId = document.getElementById('clientId').value.trim();
            const clientAddress = document.getElementById('clientAddress').value.trim();
            const clientPhone = document.getElementById('clientPhone').value.trim();
            const clientEmails = document.getElementById('clientEmails').value.trim();
            const invoiceDate = document.getElementById('invoiceDate').value;
            const docType = document.getElementById('docType').value;
            const paymentMethod = document.getElementById('paymentMethod').value;

            if (!clientName) {
                document.getElementById('clientName').parentElement.classList.add('has-error');
                showAlert('El nombre del cliente es obligatorio.', 'warning');
                isValid = false;
            }
            if (!validateClientId(clientId)) {
                document.getElementById('clientId').parentElement.classList.add('has-error');
                showAlert('El RIF o cédula no tiene un formato válido (Ej: V-12345678 o J-12345678-9).', 'warning');
                isValid = false;
            }
            if (!clientAddress) {
                document.getElementById('clientAddress').parentElement.classList.add('has-error');
                showAlert('La dirección del cliente es obligatoria.', 'warning');
                isValid = false;
            }
            if (clientPhone && !validatePhone(clientPhone)) {
                document.getElementById('clientPhone').parentElement.classList.add('has-error');
                showAlert('El teléfono debe tener un formato válido (Ej: +584123456789).', 'warning');
                isValid = false;
            }
            if (!validateEmails(clientEmails)) {
                document.getElementById('clientEmails').parentElement.classList.add('has-error');
                showAlert('Ingresa al menos un correo electrónico válido (Ej: cliente@correo.com).', 'warning');
                isValid = false;
            }
            if (!invoiceDate) {
                document.getElementById('invoiceDate').parentElement.classList.add('has-error');
                showAlert('La fecha de emisión es obligatoria.', 'warning');
                isValid = false;
            }
            if (!docType) {
                document.getElementById('docType').parentElement.classList.add('has-error');
                showAlert('Selecciona un tipo de documento.', 'warning');
                isValid = false;
            }
            if (!paymentMethod) {
                document.getElementById('paymentMethod').parentElement.classList.add('has-error');
                showAlert('Selecciona un método de pago.', 'warning');
                isValid = false;
            }

            try {
                calculateItemTotals();
            } catch (error) {
                isValid = false;
            }

            return isValid;
        }

        /**
         * Agrega un nuevo ítem al formulario.
         */
        function addItem() {
            const itemsTableBody = document.getElementById('itemsTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" class="item-description" placeholder="Descripción del artículo" required></td>
                <td><input type="number" class="item-quantity" min="1" value="1" required></td>
                <td><input type="number" step="0.01" class="item-price" min="0" value="0.00" placeholder="Precio en Bs." required></td>
                <td class="item-subtotal">0.00</td>
                <td><button class="btn-secondary remove-item">X</button></td>
            `;
            itemsTableBody.appendChild(newRow);

            newRow.querySelector('.item-quantity').addEventListener('input', updateSummary);
            newRow.querySelector('.item-price').addEventListener('input', updateSummary);
            newRow.querySelector('.item-description').addEventListener('input', updateSummary);
            newRow.querySelector('.remove-item').addEventListener('click', function() {
                this.closest('tr').remove();
                updateSummary();
            });

            updateSummary();
            newRow.querySelector('.item-description').focus();
        }

        /**
         * Cancela el formulario y regresa a la lista de facturas.
         */
        function cancelInvoice() {
            document.getElementById('invoiceList').classList.remove('hidden');
            document.getElementById('invoiceForm').classList.add('hidden');
            document.querySelectorAll('.has-error').forEach(el => el.classList.remove('has-error'));
            updateDashboardStats();
            loadInvoices();
        }

        /**
         * Genera el número de control y número de documento para una nueva factura.
         * @param {string} docType - Tipo de documento (factura, nota_credito, nota_debito).
         * @returns {object} - Objeto con controlNumber y docNumber.
         */
        function generateInvoiceNumbers(docType) {
            const lastDocNumbers = JSON.parse(localStorage.getItem('lastDocNumbers') || '{}');
            let lastNumber = lastDocNumbers[docType] || 0;
            lastNumber += 1;
            lastDocNumbers[docType] = lastNumber;
            localStorage.setItem('lastDocNumbers', JSON.stringify(lastDocNumbers));
            localStorage.setItem('lastControlNumber', lastNumber.toString());
            return {
                controlNumber: `${lastNumber.toString().padStart(8, '0')}`,
                docNumber: `${docType.toUpperCase().substring(0, 3)}-${lastNumber.toString().padStart(8, '0')}`
            };
        }

        /**
         * Genera un objeto con los datos de la factura para guardarla o previsualizarla.
         * @returns {object} - Datos de la factura.
         */
        function getInvoiceFormData() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser || !currentUser.email) {
                showAlert('Error: No se pudo identificar al usuario actual. Por favor, inicia sesión nuevamente.', 'danger');
                return null;
            }

            const subtotal = calculateItemTotals();
            const { iva, igtf, specialTax, total } = calculateTaxesAndTotal(subtotal);
            const paymentMethod = document.getElementById('paymentMethod').value;
            const docType = document.getElementById('docType').value;
            const { controlNumber, docNumber } = generateInvoiceNumbers(docType);

            return {
                id: Date.now().toString(),
                sellerId: currentUser.email,
                sellerName: currentUser.companyName,
                sellerRif: currentUser.rif,
                sellerAddress: currentUser.address,
                sellerPhone: currentUser.phone,
                clientName: document.getElementById('clientName').value.trim(),
                clientId: document.getElementById('clientId').value.trim(),
                clientAddress: document.getElementById('clientAddress').value.trim(),
                clientPhone: document.getElementById('clientPhone').value.trim(),
                clientEmails: document.getElementById('clientEmails').value.trim(),
                date: document.getElementById('invoiceDate').value,
                docType: docType,
                docNumber: docNumber,
                controlNumber: controlNumber,
                operationCode: document.getElementById('operationCode').value.trim() || 'N/A',
                paymentMethod: paymentMethod,
                notes: document.getElementById('invoiceNotes').value.trim(),
                items: Array.from(document.querySelectorAll('#itemsTableBody tr')).map(row => ({
                    description: row.querySelector('.item-description').value.trim(),
                    quantity: parseFloat(row.querySelector('.item-quantity').value),
                    price: parseFloat(row.querySelector('.item-price').value),
                    subtotal: parseFloat(row.querySelector('.item-subtotal').textContent)
                })),
                subtotal: subtotal,
                iva: iva,
                igtf: igtf,
                specialTax: specialTax,
                total: total,
                totalUSD: total / exchangeRate
            };
        }

        /**
         * Muestra una previsualización de la factura desde el formulario.
         */
        function previewInvoice() {
            if (!validateForm()) {
                showAlert('Por favor, corrige los errores en el formulario antes de previsualizar.', 'danger');
                return;
            }

            const invoice = getInvoiceFormData();
            if (!invoice) return;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Previsualización de ${invoice.docType === 'factura' ? 'Factura' : invoice.docType === 'nota_credito' ? 'Nota de Crédito' : 'Nota de Débito'} #${invoice.controlNumber}</h3>
                    <div class="modal-body">
                        <p><strong>Emisor:</strong> ${invoice.sellerName} (RIF: ${invoice.sellerRif})</p>
                        <p><strong>Cliente:</strong> ${invoice.clientName} (RIF/Cédula: ${invoice.clientId})</p>
                        <p><strong>Fecha:</strong> ${formatDate(invoice.date)}</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.items.map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.quantity}</td>
                                        <td>${formatCurrency(item.price)} Bs.</td>
                                        <td>${formatCurrency(item.subtotal)} Bs.</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="totals">
                            <p><strong>Subtotal:</strong> ${formatCurrency(invoice.subtotal)} Bs.</p>
                            <p><strong>IVA (16%):</strong> ${formatCurrency(invoice.iva)} Bs.</p>
                            <p><strong>IGTF (3%):</strong> ${formatCurrency(invoice.igtf)} Bs.</p>
                            <p><strong>Retención Especial:</strong> ${formatCurrency(invoice.specialTax)} Bs.</p>
                            <p><strong>Total:</strong> ${formatCurrency(invoice.total)} Bs.</p>
                            <p><strong>Total USD:</strong> ${formatCurrency(invoice.totalUSD)} USD</p>
                            <p><strong>Notas:</strong> ${invoice.notes || 'Sin notas'}</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary close-modal">Cerrar</button>
                        <button class="btn print-modal">Imprimir</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
            modal.querySelector('.print-modal').addEventListener('click', () => {
                printInvoice({ target: { getAttribute: () => invoice.id } });
                modal.remove();
            });
        }

        /**
         * Guarda la factura en localStorage.
         */
        function saveInvoice() {
            if (!validateForm()) {
                showAlert('Por favor, corrige los errores en el formulario.', 'danger');
                return;
            }

            const invoiceLimit = parseInt(localStorage.getItem('invoiceLimit') || '100');
            if (invoiceLimit <= 0) {
                showAlert('No tienes facturas disponibles. Por favor, compra más facturas.', 'danger');
                return;
            }

            const invoice = getInvoiceFormData();
            if (!invoice) return;

            let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            invoices.push(invoice);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            localStorage.setItem('invoiceLimit', (invoiceLimit - 1).toString());

            showAlert('Factura generada exitosamente.', 'success');
            loadInvoices();
            cancelInvoice();
            updateDashboardStats();
        }

        /**
         * Muestra una previsualización de una factura existente.
         * @param {Event} event - Evento del botón "Ver".
         */
        function viewInvoice(event) {
            const invoiceId = event.target.getAttribute('data-id');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const invoice = invoices.find(i => i.id === invoiceId);
            if (!invoice) return;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>${invoice.docType === 'factura' ? 'Factura' : invoice.docType === 'nota_credito' ? 'Nota de Crédito' : 'Nota de Débito'} #${invoice.controlNumber}</h3>
                    <div class="modal-body">
                        <p><strong>Emisor:</strong> ${invoice.sellerName} (RIF: ${invoice.sellerRif})</p>
                        <p><strong>Cliente:</strong> ${invoice.clientName} (RIF/Cédula: ${invoice.clientId})</p>
                        <p><strong>Fecha:</strong> ${formatDate(invoice.date)}</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.items.map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.quantity}</td>
                                        <td>${formatCurrency(item.price)} Bs.</td>
                                        <td>${formatCurrency(item.subtotal)} Bs.</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="totals">
                            <p><strong>Subtotal:</strong> ${formatCurrency(invoice.subtotal)} Bs.</p>
                            <p><strong>IVA (16%):</strong> ${formatCurrency(invoice.iva)} Bs.</p>
                            <p><strong>IGTF (3%):</strong> ${formatCurrency(invoice.igtf)} Bs.</p>
                            <p><strong>Retención Especial:</strong> ${formatCurrency(invoice.specialTax)} Bs.</p>
                            <p><strong>Total:</strong> ${formatCurrency(invoice.total)} Bs.</p>
                            <p><strong>Total USD:</strong> ${formatCurrency(invoice.totalUSD)} USD</p>
                            <p><strong>Notas:</strong> ${invoice.notes || 'Sin notas'}</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary close-modal">Cerrar</button>
                        <button class="btn print-modal">Imprimir</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
            modal.querySelector('.print-modal').addEventListener('click', () => {
                printInvoice({ target: { getAttribute: () => invoice.id } });
                modal.remove();
            });
        }

        /**
         * Imprime la factura (abre la vista de impresión).
         * @param {Event} event - Evento del botón "Imprimir".
         */
        function printInvoice(event) {
            const invoiceId = event.target.getAttribute('data-id');
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const invoice = invoices.find(i => i.id === invoiceId);

            if (invoice) {
                const printWindow = window.open('', '', 'height=600,width=800');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>${invoice.docType === 'factura' ? 'Factura' : invoice.docType === 'nota_credito' ? 'Nota de Crédito' : 'Nota de Débito'} #${invoice.controlNumber}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            h1 { text-align: center; color: #2968c8; }
                            .invoice-header { margin-bottom: 20px; }
                            .invoice-header p { margin: 5px 0; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background: #f8f9fa; font-weight: bold; }
                            .totals { margin-top: 20px; }
                            .totals p { margin: 5px 0; }
                        </style>
                    </head>
                    <body>
                        <h1>${invoice.docType === 'factura' ? 'Factura' : invoice.docType === 'nota_credito' ? 'Nota de Crédito' : 'Nota de Débito'} #${invoice.controlNumber}</h1>
                        <div class="invoice-header">
                            <p><strong>Emisor:</strong> ${invoice.sellerName} (RIF: ${invoice.sellerRif})</p>
                            <p><strong>Dirección:</strong> ${invoice.sellerAddress}</p>
                            <p><strong>Teléfono:</strong> ${invoice.sellerPhone}</p>
                            <p><strong>Cliente:</strong> ${invoice.clientName} (RIF/Cédula: ${invoice.clientId})</p>
                            <p><strong>Dirección Cliente:</strong> ${invoice.clientAddress}</p>
                            <p><strong>Teléfono Cliente:</strong> ${invoice.clientPhone || 'N/A'}</p>
                            <p><strong>Correos Cliente:</strong> ${invoice.clientEmails || 'N/A'}</p>
                            <p><strong>Fecha:</strong> ${formatDate(invoice.date)}</p>
                            <p><strong>Método de Pago:</strong> ${invoice.paymentMethod.replace('_', ' ').toUpperCase()}</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.items.map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.quantity}</td>
                                        <td>${formatCurrency(item.price)} Bs.</td>
                                        <td>${formatCurrency(item.subtotal)} Bs.</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="totals">
                            <p><strong>Subtotal:</strong> ${formatCurrency(invoice.subtotal)} Bs.</p>
                            <p><strong>IVA (16%):</strong> ${formatCurrency(invoice.iva)} Bs.</p>
                            <p><strong>IGTF (3%):</strong> ${formatCurrency(invoice.igtf)} Bs.</p>
                            <p><strong>Retención Especial:</strong> ${formatCurrency(invoice.specialTax)} Bs.</p>
                            <p><strong>Total:</strong> ${formatCurrency(invoice.total)} Bs.</p>
                            <p><strong>Total USD:</strong> ${formatCurrency(invoice.totalUSD)} USD</p>
                            <p><strong>Notas:</strong> ${invoice.notes || 'Sin notas'}</p>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }
        }

        /**
         * Carga la lista de clientes en la tabla.
         */
        function loadClients() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const clients = JSON.parse(localStorage.getItem('clients') || '[]');
            const userClients = clients.filter(client => client.sellerId === currentUser.email);
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = '';

            if (userClients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No hay clientes registrados.</td></tr>';
                return;
            }

            userClients.forEach(client => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${client.name}</td>
                    <td>${client.id}</td>
                    <td>${client.address}</td>
                    <td>${client.phone || 'N/A'}</td>
                    <td>${client.invoiceCount || 0}</td>
                    <td>
                        <button class="btn btn-secondary edit-client" data-id="${client.id}">Editar</button>
                        <button class="btn btn-secondary delete-client" data-id="${client.id}">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * Muestra el formulario de edición o creación de cliente.
         * @param {Event} event - Evento del botón "Editar" (opcional).
         */
        function showClientForm(client = null) {
            const clientForm = document.createElement('div');
            clientForm.id = 'clientForm';
            clientForm.className = 'invoice-form tab-content';
            clientForm.innerHTML = `
                <h2>${client ? 'Editar Cliente' : 'Nuevo Cliente'}</h2>
                <div class="form-section">
                    <div class="form-group">
                        <label for="clientFormName">Nombre o Razón Social*</label>
                        <input type="text" id="clientFormName" value="${client ? client.name : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="clientFormId">Cédula o RIF*</label>
                        <input type="text" id="clientFormId" value="${client ? client.id : ''}" placeholder="Ej: V-12345678 o J-12345678-9" required>
                    </div>
                    <div class="form-group">
                        <label for="clientFormAddress">Dirección*</label>
                        <input type="text" id="clientFormAddress" value="${client ? client.address : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="clientFormPhone">Teléfono</label>
                        <input type="text" id="clientFormPhone" value="${client ? client.phone : ''}">
                    </div>
                    <div class="form-group">
                        <label for="clientFormEmails">Correos Electrónicos (separados por comas)*</label>
                        <input type="text" id="clientFormEmails" value="${client ? client.emails : ''}" placeholder="Ej: cliente@correo.com" required>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="cancelClientBtn">Cancelar</button>
                    <button class="btn btn-success" id="saveClientBtn">${client ? 'Guardar Cambios' : 'Guardar Cliente'}</button>
                </div>
            `;
            document.getElementById('contentClients').appendChild(clientForm);
            document.getElementById('clientsTable').classList.add('hidden');

            document.getElementById('saveClientBtn').addEventListener('click', saveClient);
            document.getElementById('cancelClientBtn').addEventListener('click', cancelClient);
        }

        /**
         * Inicia la edición de un cliente.
         * @param {Event} event - Evento del botón "Editar".
         */
        function editClient(event) {
            const clientId = event.target.getAttribute('data-id');
            const clients = JSON.parse(localStorage.getItem('clients') || '[]');
            const client = clients.find(c => c.id === clientId);
            if (client) showClientForm(client);
        }

        /**
         * Elimina un cliente.
         * @param {Event} event - Evento del botón "Eliminar".
         */
        function deleteClient(event) {
            if (confirm('¿Estás seguro de eliminar este cliente? Esta acción no se puede deshacer.')) {
                const clientId = event.target.getAttribute('data-id');
                let clients = JSON.parse(localStorage.getItem('clients') || '[]');
                clients = clients.filter(c => c.id !== clientId);
                localStorage.setItem('clients', JSON.stringify(clients));
                loadClients();
                showAlert('Cliente eliminado exitosamente.', 'success');
            }
        }

        /**
         * Cancela la edición o creación de un cliente.
         */
        function cancelClient() {
                       document.getElementById('clientForm').remove();
            document.getElementById('clientsTable').classList.remove('hidden');
        }

        /**
         * Guarda o actualiza un cliente en localStorage.
         */
        function saveClient() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const name = document.getElementById('clientFormName').value.trim();
            const id = document.getElementById('clientFormId').value.trim();
            const address = document.getElementById('clientFormAddress').value.trim();
            const phone = document.getElementById('clientFormPhone').value.trim();
            const emails = document.getElementById('clientFormEmails').value.trim();

            let isValid = true;
            if (!name) {
                document.getElementById('clientFormName').parentElement.classList.add('has-error');
                showAlert('El nombre del cliente es obligatorio.', 'warning');
                isValid = false;
            }
            if (!validateClientId(id)) {
                document.getElementById('clientFormId').parentElement.classList.add('has-error');
                showAlert('El RIF o cédula no tiene un formato válido (Ej: V-12345678 o J-12345678-9).', 'warning');
                isValid = false;
            }
            if (!address) {
                document.getElementById('clientFormAddress').parentElement.classList.add('has-error');
                showAlert('La dirección del cliente es obligatoria.', 'warning');
                isValid = false;
            }
            if (phone && !validatePhone(phone)) {
                document.getElementById('clientFormPhone').parentElement.classList.add('has-error');
                showAlert('El teléfono debe tener un formato válido (Ej: +584123456789).', 'warning');
                isValid = false;
            }
            if (!validateEmails(emails)) {
                document.getElementById('clientFormEmails').parentElement.classList.add('has-error');
                showAlert('Ingresa al menos un correo electrónico válido (Ej: cliente@correo.com).', 'warning');
                isValid = false;
            }

            if (!isValid) return;

            let clients = JSON.parse(localStorage.getItem('clients') || '[]');
            const existingClient = clients.find(c => c.id === id && c.sellerId === currentUser.email);

            const clientData = {
                sellerId: currentUser.email,
                name: name,
                id: id,
                address: address,
                phone: phone || '',
                emails: emails,
                invoiceCount: existingClient ? existingClient.invoiceCount : 0
            };

            if (existingClient) {
                clients = clients.map(c => (c.id === id && c.sellerId === currentUser.email ? clientData : c));
                showAlert('Cliente actualizado exitosamente.', 'success');
            } else {
                clients.push(clientData);
                showAlert('Cliente guardado exitosamente.', 'success');
            }

            localStorage.setItem('clients', JSON.stringify(clients));
            cancelClient();
            loadClients();
        }

        /**
         * Carga los datos del perfil del usuario.
         */
        function loadProfile() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            document.getElementById('profileCompanyName').value = currentUser.companyName;
            document.getElementById('profileRif').value = currentUser.rif;
            document.getElementById('profileAddress').value = currentUser.address;
            document.getElementById('profilePhone').value = currentUser.phone || 'N/A';
            document.getElementById('profileEmail').value = currentUser.email;
            document.getElementById('profileTaxStatus').textContent = currentUser.isSpecialContributor ? 'Contribuyente Especial' : 'Normal';

            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const userInvoices = invoices.filter(invoice => invoice.sellerId === currentUser.email);
            const invoiceLimit = parseInt(localStorage.getItem('invoiceLimit') || '100');
            const availableInvoices = Math.max(0, invoiceLimit - userInvoices.length);
            const lowInvoicesWarning = document.getElementById('lowInvoicesWarning');
            if (availableInvoices < 10) {
                lowInvoicesWarning.classList.remove('hidden');
            } else {
                lowInvoicesWarning.classList.add('hidden');
            }
        }

        /**
         * Simula la compra de más facturas.
         */
        function buyMoreInvoices() {
            const currentLimit = parseInt(localStorage.getItem('invoiceLimit') || '100');
            const additionalInvoices = 100; // Simulamos la compra de 100 facturas adicionales
            const newLimit = currentLimit + additionalInvoices;
            localStorage.setItem('invoiceLimit', newLimit.toString());
            showAlert(`Has comprado ${additionalInvoices} facturas adicionales. Nuevo límite: ${newLimit}.`, 'success');
            loadProfile();
            updateDashboardStats();
        }

        // ===========================================================================
        // FIN DEL CÓDIGO
        // ===========================================================================
        // Sistema completo con dashboard, gestión de facturas, clientes y perfil.
        // ===========================================================================
    </script>
</body>
</html>
