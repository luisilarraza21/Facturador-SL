<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Plataforma</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            color: #333;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark-theme {
            background-color: #2a2a2a;
            color: #e0e0e0;
        }
        .navbar {
            background-color: #2968c8;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }
        .dark-theme .navbar {
            background-color: #1d4f9e;
        }
        .navbar:hover {
            background-color: #1d4f9e;
        }
        .dark-theme .navbar:hover {
            background-color: #153e7e;
        }
        .logo {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .logo-image {
            height: 40px;
            width: auto;
            max-width: 150px;
        }
        .logo span {
            font-size: 14px;
            font-weight: normal;
            color: #ddd;
            margin-top: 5px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 25px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }
        .dark-theme .container {
            background: #3a3a3a;
            border-color: #555;
        }
        .section-title {
            font-size: 20px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            color: #2968c8;
            font-weight: 600;
        }
        .dark-theme .section-title {
            color: #4a90e2;
            border-bottom-color: #666;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 200px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .dark-theme .stat-card {
            background: #4a4a4a;
            border-color: #666;
        }
        .stat-card h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #555;
        }
        .dark-theme .stat-card h3 {
            color: #ccc;
        }
        .stat-card p {
            font-size: 24px;
            font-weight: bold;
            color: #2968c8;
        }
        .dark-theme .stat-card p {
            color: #4a90e2;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .dark-theme th, .dark-theme td {
            border-color: #666;
        }
        th {
            background: #f1f1f1;
            font-weight: 500;
        }
        .dark-theme th {
            background: #555;
        }
        .btn {
            background: #2968c8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        .btn:hover {
            background: #1d4f9e;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .dark-theme .modal-content {
            background: #3a3a3a;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }
        .dark-theme .modal-close {
            color: #ccc;
        }
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .modal-table {
            margin: 20px 0;
        }
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 1001;
            font-size: 15px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .dark-theme .alert-success {
            background: #28a745;
            color: #fff;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .dark-theme .alert-error {
            background: #dc3545;
            color: #fff;
        }
        .activity-log {
            margin-top: 30px;
        }
        .activity-log ul {
            list-style: none;
        }
        .activity-log li {
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }
        .dark-theme .activity-log li {
            border-bottom-color: #666;
        }
        @media (max-width: 768px) {
            .container {
                margin: 15px;
                padding: 20px;
            }
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            .stat-card {
                min-width: 100%;
            }
            table th, table td {
                padding: 8px;
                font-size: 14px;
            }
            .modal-content {
                padding: 15px;
                max-width: 95%;
            }
            .modal-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">
            <img src="Logotipo E-facture-02.png" alt="Logo de la plataforma" class="logo-image">
            <span>by: Soluciones Láser</span>
        </div>
        <div class="user-info">
            <span id="userName"></span>
            <button class="btn btn-secondary" id="logoutButton">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                    <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                </svg>
                Cerrar Sesión
            </button>
        </div>
    </div>

    <div class="container">
        <h2 class="section-title">Estadísticas</h2>
        <div class="stats">
            <div class="stat-card">
                <h3>Total de Documentos</h3>
                <p id="totalDocs">0</p>
            </div>
            <div class="stat-card">
                <h3>Documentos Consumidos</h3>
                <p id="consumedDocs">0</p>
            </div>
            <div class="stat-card">
                <h3>Documentos Disponibles</h3>
                <p id="availableDocs">0</p>
            </div>
        </div>

        <h2 class="section-title">Pedidos sin Confirmar</h2>
        <table>
            <thead>
                <tr>
                    <th>Nº Documento</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th>Total (Bs)</th>
                    <th>Total (USD)</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody id="pendingOrdersBody"></tbody>
        </table>

        <h2 class="section-title">Facturas Emitidas</h2>
        <table>
            <thead>
                <tr>
                    <th>Nº Documento</th>
                    <th>Nº Control</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th>Total (Bs)</th>
                    <th>Total (USD)</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody id="invoicesBody"></tbody>
        </table>

        <div class="button-group">
            <button class="btn" id="newOrderButton">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                Nuevo Documento
            </button>
        </div>

        <div class="activity-log">
            <h2 class="section-title">Registro de Actividades</h2>
            <ul id="activityList"></ul>
        </div>
    </div>

    <div class="modal" id="viewModal">
        <div class="modal-content">
            <button class="modal-close" id="viewModalClose">&times;</button>
            <h2 class="section-title">Detalles del Documento</h2>
            <p><strong>Nº Documento:</strong> <span id="modalDocNumber"></span></p>
            <p><strong>Cliente:</strong> <span id="modalClientName"></span></p>
            <p><strong>RIF/Cédula:</strong> <span id="modalClientId"></span></p>
            <p><strong>Dirección:</strong> <span id="modalClientAddress"></span></p>
            <p><strong>Teléfono:</strong> <span id="modalClientPhone"></span></p>
            <p><strong>Correos:</strong> <span id="modalClientEmails"></span></p>
            <p><strong>Fecha:</strong> <span id="modalDate"></span></p>
            <p><strong>Subtotal (Bs):</strong> <span id="modalSubtotalBs"></span></p>
            <p><strong>IVA (Bs):</strong> <span id="modalTaxBs"></span></p>
            <p><strong>Total (Bs):</strong> <span id="modalTotalBs"></span></p>
            <p><strong>Total (USD):</strong> <span id="modalTotalUsd"></span></p>
            <p><strong>Método de Pago:</strong> <span id="modalPaymentMethod"></span></p>
            <table class="modal-table">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Descripción</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario (Bs)</th>
                        <th>Subtotal (Bs)</th>
                    </tr>
                </thead>
                <tbody id="modalItemsBody"></tbody>
            </table>
            <div class="modal-buttons">
                <button class="btn" id="editOrderButton">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                        <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                    </svg>
                    Editar Documento
                </button>
                <button class="btn" id="confirmPaymentButton">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2zm2-1a1 1 0 0 0-1 1v12.566l4.723-2.482a.5.5 0 0 1 .554 0L13 14.566V2a1 1 0 0 0-1-1H4z"/>
                    </svg>
                    Confirmar Pago
                </button>
                <button class="btn" id="generateInvoiceButton">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4 0h5.293A1 1 0 0 1 10 .293L13.707 4a1 1 0 0 1 .293.707V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zm5.5 1.5v2a1 1 0 0 0 1 1h2l-3-3z"/>
                    </svg>
                    Generar Factura
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="generateInvoiceModal">
        <div class="modal-content">
            <button class="modal-close" id="generateInvoiceModalClose">&times;</button>
            <h2 class="section-title">Confirmar Generación de Factura</h2>
            <p>¿Está seguro de que desea generar la factura para este documento? Esta acción no se puede deshacer.</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="continueEditing">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                    </svg>
                    Continuar Editando
                </button>
                <button class="btn" id="confirmGenerateInvoice">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4 0h5.293A1 1 0 0 1 10 .293L13.707 4a1 1 0 0 1 .293.707V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zm5.5 1.5v2a1 1 0 0 0 1 1h2l-3-3z"/>
                    </svg>
                    Generar Factura
                </button>
            </div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }

        function loadUserData() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'index.html';
                return null;
            }
            return currentUser;
        }

        function addActivityEntry(currentUser, message) {
            const activityLog = JSON.parse(localStorage.getItem(`activity_${currentUser.rif}`)) || [];
            const timestamp = new Date().toLocaleString('es-ES');
            activityLog.unshift(`${timestamp}: ${message}`);
            if (activityLog.length > 10) activityLog.pop();
            localStorage.setItem(`activity_${currentUser.rif}`, JSON.stringify(activityLog));
        }

        function renderPendingOrders(orders, currentUser) {
            const pendingOrdersBody = document.getElementById('pendingOrdersBody');
            pendingOrdersBody.innerHTML = '';
            const pendingOrders = orders.filter(order => order.status === 'pending' && order.userRif === currentUser.rif);
            pendingOrders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.docNumber}</td>
                    <td>${order.clientName}</td>
                    <td>${order.date}</td>
                    <td>${order.totalBs.toFixed(2)} Bs</td>
                    <td>${order.totalUsd.toFixed(2)} USD</td>
                    <td>
                        <button class="btn btn-view" data-id="${order.docNumber}">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
                                <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
                            </svg>
                            Ver
                        </button>
                    </td>
                `;
                pendingOrdersBody.appendChild(row);
            });
        }

        function renderInvoices(orders, currentUser) {
            const invoicesBody = document.getElementById('invoicesBody');
            invoicesBody.innerHTML = '';
            const invoices = orders.filter(order => order.status === 'invoiced' && order.userRif === currentUser.rif);
            invoices.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.docNumber}</td>
                    <td>${order.controlNumber}</td>
                    <td>${order.clientName}</td>
                    <td>${order.date}</td>
                    <td>${order.totalBs.toFixed(2)} Bs</td>
                    <td>${order.totalUsd.toFixed(2)} USD</td>
                    <td>
                        <button class="btn btn-view" data-id="${order.docNumber}">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
                                <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
                            </svg>
                            Ver
                        </button>
                    </td>
                `;
                invoicesBody.appendChild(row);
            });
        }

        function generateControlNumber(orders, userRif) {
            const userOrders = orders.filter(order => order.userRif === userRif && order.controlNumber);
            const controlCount = userOrders.length + 1;
            return `00-${String(controlCount).padStart(8, '0')}`;
        }

        function formatCurrency(amount) {
            return amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function generateInvoice(docNumber) {
            const currentUser = loadUserData();
            if (!currentUser) return;

            let orders = JSON.parse(localStorage.getItem('orders')) || [];
            const order = orders.find(o => o.docNumber === docNumber && o.userRif === currentUser.rif);
            if (!order) {
                showAlert('No se encontró el documento para generar la factura.', 'error');
                return;
            }

            order.status = 'invoiced';
            order.controlNumber = generateControlNumber(orders, currentUser.rif);
            localStorage.setItem('orders', JSON.stringify(orders));

            const templateId = localStorage.getItem('selectedTemplate') || 1;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4',
                putOnlyUsedFonts: true,
                floatPrecision: 16,
                compress: true
            });
            const logo = currentUser.profilePic || 'https://via.placeholder.com/100';
            const margin = 5;
            const pageWidth = doc.internal.pageSize.getWidth() - 2 * margin;
            let y = margin;

            function addText(text, x, align = 'left') {
                const lines = doc.splitTextToSize(text, pageWidth - 10);
                lines.forEach(line => {
                    if (y > doc.internal.pageSize.getHeight() - 10) {
                        doc.addPage();
                        y = margin;
                    }
                    doc.text(line, x, y, { align: align });
                    y += 3;
                });
                return y;
            }

            if (templateId == 1) {
                doc.addImage(logo, 'JPEG', (pageWidth / 2) + margin - 15, y, 30, 30, undefined, 'FAST');
                y += 35;
                doc.setFontSize(12);
                y = addText(currentUser.companyName, (pageWidth / 2) + margin, 'center');
                doc.setFontSize(8);
                y = addText(`RIF: ${currentUser.rif}`, (pageWidth / 2) + margin, 'center');
                y = addText(`Dirección: ${currentUser.address}`, (pageWidth / 2) + margin, 'center');
                y = addText(`Teléfono: ${currentUser.phone}`, (pageWidth / 2) + margin, 'center');
                y += 5;
                doc.setFontSize(12);
                y = addText('Factura', margin, 'left');
                doc.setFontSize(8);
                y = addText(`Nº Documento: ${order.docNumber}`, margin, 'left');
                y = addText(`Nº Control: ${order.controlNumber}`, margin, 'left');
                y = addText(`Fecha: ${order.date}`, margin, 'left');
                y += 5;
                y = addText(`Cliente: ${order.clientName}`, margin, 'left');
                y = addText(`RIF/Cédula: ${order.clientId}`, margin, 'left');
                y = addText(`Dirección: ${order.clientAddress}`, margin, 'left');
                y = addText(`Teléfono: ${order.clientPhone}`, margin, 'left');
                y = addText(`Correos: ${order.clientEmails.join(', ')}`, margin, 'left');
            } else if (templateId == 2) {
                doc.addImage(logo, 'JPEG', margin, y, 30, 30, undefined, 'FAST');
                doc.setFontSize(12);
                y = addText(currentUser.companyName, margin + 35, 'left');
                doc.setFontSize(8);
                y = addText(`RIF: ${currentUser.rif}`, margin + 35, 'left');
                y += 5;
                doc.setFontSize(12);
                y = addText('Factura', pageWidth + margin, 'right');
                doc.setFontSize(8);
                y = addText(`Nº Documento: ${order.docNumber}`, pageWidth + margin, 'right');
                y = addText(`Nº Control: ${order.controlNumber}`, pageWidth + margin, 'right');
                y = addText(`Fecha: ${order.date}`, pageWidth + margin, 'right');
                y += 5;
                y = addText(`Cliente: ${order.clientName}`, margin, 'left');
                y = addText(`RIF/Cédula: ${order.clientId}`, margin, 'left');
                y = addText(`Dirección: ${order.clientAddress}`, margin, 'left');
                y = addText(`Teléfono: ${order.clientPhone}`, margin, 'left');
                y = addText(`Correos: ${order.clientEmails.join(', ')}`, margin, 'left');
            } else if (templateId == 3) {
                doc.addImage(logo, 'JPEG', (pageWidth / 2) + margin - 15, y, 30, 30, undefined, 'FAST');
                y += 35;
                doc.setFontSize(12);
                y = addText(currentUser.companyName, (pageWidth / 2) + margin, 'center');
                doc.setFontSize(8);
                y = addText(`RIF: ${currentUser.rif}`, (pageWidth / 2) + margin, 'center');
                y = addText(`Dirección: ${currentUser.address}`, (pageWidth / 2) + margin, 'center');
                y = addText(`Teléfono: ${currentUser.phone}`, (pageWidth / 2) + margin, 'center');
                y += 5;
                doc.setFontSize(12);
                y = addText('Factura', margin, 'left');
                doc.setFontSize(8);
                y = addText(`Nº Documento: ${order.docNumber}`, margin, 'left');
                y = addText(`Nº Control: ${order.controlNumber}`, margin, 'left');
                y = addText(`Fecha: ${order.date}`, margin, 'left');
                y += 5;
                y = addText(`Cliente: ${order.clientName}`, margin, 'left');
                y = addText(`RIF/Cédula: ${order.clientId}`, margin, 'left');
                y = addText(`Dirección: ${order.clientAddress}`, margin, 'left');
                y = addText(`Teléfono: ${order.clientPhone}`, margin, 'left');
                y = addText(`Correos: ${order.clientEmails.join(', ')}`, margin, 'left');
            }

            y += 5;
            doc.autoTable({
                head: [['Código', 'Descripción', 'Cantidad', 'Precio Unitario (Bs)', 'Subtotal (Bs)']],
                body: order.items.map(item => [
                    item.code || '-',
                    item.description,
                    item.quantity,
                    formatCurrency(item.price),
                    formatCurrency(item.subtotal)
                ]),
                startY: y,
                theme: 'striped',
                styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                columnStyles: { 0: { cellWidth: 15 }, 1: { cellWidth: 50 }, 2: { cellWidth: 15 }, 3: { cellWidth: 25 }, 4: { cellWidth: 25 } },
                margin: { top: margin },
                didDrawPage: () => { y = doc.lastAutoTable.finalY + 3; }
            });
            y = doc.lastAutoTable.finalY + 3;

            const totalTableData = [
                ['Subtotal', formatCurrency(order.subtotalBs), formatCurrency(order.subtotalUsd)],
                ['Monto exento', formatCurrency(order.exemptAmountBs), formatCurrency(order.exemptAmountUsd)],
                ['Base imponible', formatCurrency(order.taxableBaseBs), formatCurrency(order.taxableBaseUsd)],
                [`IVA (${order.alicuota}%)`, formatCurrency(order.taxBs), formatCurrency(order.taxUsd)],
                ['IGTF (3%)', formatCurrency(order.igtfBs), formatCurrency(order.igtfUsd)],
                ['Total', formatCurrency(order.totalBs), formatCurrency(order.totalUsd)]
            ];

            doc.autoTable({
                head: [['', 'Bs', 'USD']],
                body: totalTableData,
                startY: y,
                theme: 'striped',
                styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                columnStyles: { 0: { cellWidth: 30 }, 1: { cellWidth: 30 }, 2: { cellWidth: 30 } },
                margin: { left: pageWidth - 90 + margin },
                didDrawPage: () => { y = doc.lastAutoTable.finalY + 3; }
            });
            y = doc.lastAutoTable.finalY + 3;

            doc.setFontSize(8);
            y = addText(`Método de Pago: ${order.paymentMethod}`, margin, 'left');
            y = addText(`Tasa de cambio: ${order.exchangeRate} Bs/USD`, margin, 'left');
            y += 5;
            doc.setFontSize(7);
            doc.setTextColor(100);
            doc.setLineWidth(0.5);
            doc.line(margin, y, pageWidth + margin, y);
            y += 3;
            const controlNumber = order.controlNumber;
            const invoiceDate = order.date;
            const footerText = `ESTE DOCUMENTO SE EMITE BAJO LA PROVIDENCIA ADMINISTRATIVA SNAT/2024/000102 DE FECHA 17/10/2024\n` +
                              `SOLUCIONES LASER, C.A RIF: J-003629162. N.º DE PROVIDENCIA: SENIAT/INTI/2021 0000029 DE FECHA 16/06/2021.\n` +
                              `No. CONTROL ${controlNumber} HASTA No. CONTROL ${controlNumber} DE FECHA ${invoiceDate}`;
            y = addText(footerText, (pageWidth / 2) + margin, 'center');

            doc.save(`Factura_${order.docNumber}.pdf`);
            addActivityEntry(currentUser, `Factura generada para el documento ${order.docNumber}`);

            renderPendingOrders(orders, currentUser);
            renderInvoices(orders, currentUser);

            const totalDocs = parseInt(localStorage.getItem(`totalDocs_${currentUser.rif}`)) || 0;
            const consumedDocs = parseInt(localStorage.getItem(`consumedDocs_${currentUser.rif}`)) || 0;
            localStorage.setItem(`consumedDocs_${currentUser.rif}`, consumedDocs + 1);
            document.getElementById('consumedDocs').textContent = consumedDocs + 1;
            document.getElementById('availableDocs').textContent = totalDocs - (consumedDocs + 1);

            showAlert('Factura generada exitosamente.', 'success');
            document.getElementById('viewModal').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = loadUserData();
            if (!currentUser) return;

            if (currentUser.darkTheme) {
                document.body.classList.add('dark-theme');
            }

            document.getElementById('userName').textContent = currentUser.name;

            const totalDocs = parseInt(localStorage.getItem(`totalDocs_${currentUser.rif}`)) || 0;
            const consumedDocs = parseInt(localStorage.getItem(`consumedDocs_${currentUser.rif}`)) || 0;
            document.getElementById('totalDocs').textContent = totalDocs;
            document.getElementById('consumedDocs').textContent = consumedDocs;
            document.getElementById('availableDocs').textContent = totalDocs - consumedDocs;

            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            renderPendingOrders(orders, currentUser);
            renderInvoices(orders, currentUser);

            const activityLog = JSON.parse(localStorage.getItem(`activity_${currentUser.rif}`)) || [];
            const activityList = document.getElementById('activityList');
            activityLog.forEach(entry => {
                const li = document.createElement('li');
                li.textContent = entry;
                activityList.appendChild(li);
            });

            document.getElementById('pendingOrdersBody').addEventListener('click', (e) => {
                const viewButton = e.target.closest('.btn-view');
                if (viewButton) {
                    const docNumber = viewButton.getAttribute('data-id');
                    const order = orders.find(o => o.docNumber === docNumber && o.userRif === currentUser.rif);
                    if (order) {
                        document.getElementById('modalDocNumber').textContent = order.docNumber;
                        document.getElementById('modalClientName').textContent = order.clientName;
                        document.getElementById('modalClientId').textContent = order.clientId;
                        document.getElementById('modalClientAddress').textContent = order.clientAddress;
                        document.getElementById('modalClientPhone').textContent = order.clientPhone;
                        document.getElementById('modalClientEmails').textContent = order.clientEmails.join(', ');
                        document.getElementById('modalDate').textContent = order.date;
                        document.getElementById('modalSubtotalBs').textContent = order.subtotalBs.toFixed(2);
                        document.getElementById('modalTaxBs').textContent = order.taxBs.toFixed(2);
                        document.getElementById('modalTotalBs').textContent = order.totalBs.toFixed(2);
                        document.getElementById('modalTotalUsd').textContent = order.totalUsd.toFixed(2);
                        document.getElementById('modalPaymentMethod').textContent = order.paymentMethod;

                        const itemsBody = document.getElementById('modalItemsBody');
                        itemsBody.innerHTML = '';
                        order.items.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.code || '-'}</td>
                                <td>${item.description}</td>
                                <td>${item.quantity}</td>
                                <td>${item.price.toFixed(2)}</td>
                                <td>${item.subtotal.toFixed(2)}</td>
                            `;
                            itemsBody.appendChild(row);
                        });

                        const editButton = document.getElementById('editOrderButton');
                        const confirmPaymentButton = document.getElementById('confirmPaymentButton');
                        const generateInvoiceButton = document.getElementById('generateInvoiceButton');

                        editButton.style.display = order.status === 'pending' ? 'inline-flex' : 'none';
                        confirmPaymentButton.style.display = order.status === 'pending' ? 'inline-flex' : 'none';
                        generateInvoiceButton.style.display = order.status === 'paid' ? 'inline-flex' : 'none';

                        editButton.onclick = () => {
                            localStorage.setItem('editOrder', JSON.stringify(order));
                            window.location.href = `nueva-factura.html?edit=${order.docNumber}`;
                        };

                        confirmPaymentButton.onclick = () => {
                            order.status = 'paid';
                            localStorage.setItem('orders', JSON.stringify(orders));
                            addActivityEntry(currentUser, `Pago confirmado para el documento ${order.docNumber}`);
                            showAlert('Pago confirmado.', 'success');
                            renderPendingOrders(orders, currentUser);
                            confirmPaymentButton.style.display = 'none';
                            generateInvoiceButton.style.display = 'inline-flex';
                        };

                        generateInvoiceButton.onclick = () => {
                            const totalDocs = parseInt(localStorage.getItem(`totalDocs_${currentUser.rif}`)) || 0;
                            const consumedDocs = parseInt(localStorage.getItem(`consumedDocs_${currentUser.rif}`)) || 0;
                            if (consumedDocs >= totalDocs) {
                                showAlert('No hay documentos disponibles para emitir facturas.', 'error');
                                return;
                            }
                            document.getElementById('generateInvoiceModal').style.display = 'flex';
                            document.getElementById('confirmGenerateInvoice').onclick = () => {
                                document.getElementById('generateInvoiceModal').style.display = 'none';
                                generateInvoice(order.docNumber);
                            };
                        };

                        document.getElementById('viewModal').style.display = 'flex';
                    }
                }
            });

            document.getElementById('invoicesBody').addEventListener('click', (e) => {
                const viewButton = e.target.closest('.btn-view');
                if (viewButton) {
                    const docNumber = viewButton.getAttribute('data-id');
                    const order = orders.find(o => o.docNumber === docNumber && o.userRif === currentUser.rif);
                    if (order) {
                        document.getElementById('modalDocNumber').textContent = order.docNumber;
                        document.getElementById('modalClientName').textContent = order.clientName;
                        document.getElementById('modalClientId').textContent = order.clientId;
                        document.getElementById('modalClientAddress').textContent = order.clientAddress;
                        document.getElementById('modalClientPhone').textContent = order.clientPhone;
                        document.getElementById('modalClientEmails').textContent = order.clientEmails.join(', ');
                        document.getElementById('modalDate').textContent = order.date;
                        document.getElementById('modalSubtotalBs').textContent = order.subtotalBs.toFixed(2);
                        document.getElementById('modalTaxBs').textContent = order.taxBs.toFixed(2);
                        document.getElementById('modalTotalBs').textContent = order.totalBs.toFixed(2);
                        document.getElementById('modalTotalUsd').textContent = order.totalUsd.toFixed(2);
                        document.getElementById('modalPaymentMethod').textContent = order.paymentMethod;

                        const itemsBody = document.getElementById('modalItemsBody');
                        itemsBody.innerHTML = '';
                        order.items.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.code || '-'}</td>
                                <td>${item.description}</td>
                                <td>${item.quantity}</td>
                                <td>${item.price.toFixed(2)}</td>
                                <td>${item.subtotal.toFixed(2)}</td>
                            `;
                            itemsBody.appendChild(row);
                        });

                        document.getElementById('editOrderButton').style.display = 'none';
                        document.getElementById('confirmPaymentButton').style.display = 'none';
                        document.getElementById('generateInvoiceButton').style.display = 'none';

                        document.getElementById('viewModal').style.display = 'flex';
                    }
                }
            });

            document.getElementById('viewModalClose').addEventListener('click', () => {
                document.getElementById('viewModal').style.display = 'none';
            });

            document.getElementById('continueEditing').addEventListener('click', () => {
                document.getElementById('generateInvoiceModal').style.display = 'none';
            });

            document.getElementById('generateInvoiceModalClose').addEventListener('click', () => {
                document.getElementById('generateInvoiceModal').style.display = 'none';
            });

            document.getElementById('newOrderButton').addEventListener('click', () => {
                window.location.href = 'nueva-factura.html';
            });

            document.getElementById('logoutButton').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });
        });
    </script>
</body>
</html>
