<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wakal Blitz - Nuevo Pedido</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            color: #333;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark-theme {
            background-color: #2a2a2a;
            color: #e0e0e0;
        }
        .navbar {
            background-color: #2968c8;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }
        .dark-theme .navbar {
            background-color: #1d4f9e;
        }
        .navbar:hover {
            background-color: #1d4f9e;
        }
        .dark-theme .navbar:hover {
            background-color: #153e7e;
        }
        .logo {
            font-weight: bold;
            font-size: 24px;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .logo span {
            font-size: 14px;
            font-weight: normal;
            display: block;
            color: #ddd;
        }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 25px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }
        .dark-theme .container {
            background: #3a3a3a;
            border-color: #555;
        }
        .section-title {
            font-size: 20px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            color: #2968c8;
            font-weight: 600;
        }
        .dark-theme .section-title {
            color: #4a90e2;
            border-bottom-color: #666;
        }
        .form-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
        }
        .dark-theme label {
            color: #ccc;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: #f9f9f9;
        }
        .dark-theme input, .dark-theme select, .dark-theme textarea {
            background: #4a4a4a;
            border-color: #666;
            color: #e0e0e0;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 6px rgba(40, 167, 69, 0.2);
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        .item-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .item-table th, .item-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .dark-theme .item-table th, .dark-theme .item-table td {
            border-color: #666;
        }
        .item-table th {
            background: #f1f1f1;
            font-weight: 500;
        }
        .dark-theme .item-table th {
            background: #555;
        }
        .item-table input {
            width: 100%;
            padding: 8px;
            border: none;
            background: transparent;
        }
        .dark-theme .item-table input {
            color: #e0e0e0;
        }
        .item-table input:focus {
            outline: none;
            border: 1px solid #28a745;
            border-radius: 4px;
        }
        .btn {
            background: linear-gradient(90deg, #2968c8, #28a745);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        .btn:hover {
            background: linear-gradient(90deg, #1d4f9e, #218838);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            text-align: center;
        }
        .dark-theme .modal-content {
            background: #3a3a3a;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .modal-close:hover {
            background: #c82333;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 1001;
            font-size: 15px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .dark-theme .alert-success {
            background: #28a745;
            color: #fff;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .dark-theme .alert-error {
            background: #dc3545;
            color: #fff;
        }
        @media (max-width: 768px) {
            .container {
                margin: 15px;
                padding: 20px;
            }
            .button-group {
                justify-content: center;
            }
            .item-table th, .item-table td {
                padding: 8px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">Wakal Blitz<span>by: Soluciones Láser</span></div>
    </div>

    <div class="container">
        <h2 class="section-title">Nuevo Pedido</h2>

        <div class="form-group">
            <label for="docType">Tipo de Documento</label>
            <select id="docType" required>
                <option value="factura">Factura</option>
                <option value="nota-entrega">Nota de Entrega</option>
            </select>
        </div>

        <div class="form-group">
            <label for="docNumber">Nº Documento</label>
            <input type="text" id="docNumber" required readonly value="Generado automáticamente">
        </div>

        <div class="form-group">
            <label for="controlNumber">Nº Control</label>
            <input type="text" id="controlNumber" required readonly value="Generado automáticamente">
        </div>

        <div class="form-group">
            <label for="date">Fecha</label>
            <input type="date" id="date" required>
        </div>

        <div class="form-group">
            <label for="clientName">Nombre del Cliente</label>
            <input type="text" id="clientName" required>
        </div>

        <div class="form-group">
            <label for="clientId">RIF/Cédula del Cliente</label>
            <input type="text" id="clientId" required placeholder="Ejemplo: V-12345678">
        </div>

        <div class="form-group">
            <label for="clientAddress">Dirección del Cliente</label>
            <textarea id="clientAddress" required></textarea>
        </div>

        <div class="form-group">
            <label for="clientPhone">Teléfono del Cliente</label>
            <input type="text" id="clientPhone" required placeholder="Ejemplo: +584121234567">
        </div>

        <div class="form-group">
            <label for="clientEmail">Correo del Cliente</label>
            <input type="email" id="clientEmail" required>
        </div>

        <div class="form-group">
            <h3 class="section-title">Ítems del Pedido</h3>
            <table class="item-table" id="itemTable">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Descripción</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario (Bs)</th>
                        <th>Subtotal (Bs)</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="itemTableBody">
                    <tr>
                        <td><input type="text" class="item-code" placeholder="001"></td>
                        <td><input type="text" class="item-description" required></td>
                        <td><input type="number" class="item-quantity" required min="1" value="1"></td>
                        <td><input type="number" class="item-price" required min="0" step="0.01" value="0"></td>
                        <td><input type="text" class="item-subtotal" readonly value="0.00"></td>
                        <td>
                            <button class="btn btn-danger btn-remove-item">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                </svg>
                                Eliminar
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <button class="btn" id="addItemButton">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                Agregar Ítem
            </button>
        </div>

        <div class="form-group">
            <label for="subtotalBs">Subtotal (Bs)</label>
            <input type="text" id="subtotalBs" readonly value="0.00">
        </div>

        <div class="form-group">
            <label for="taxBs">IVA (16%) (Bs)</label>
            <input type="text" id="taxBs" readonly value="0.00">
        </div>

        <div class="form-group">
            <label for="totalBs">Total (Bs)</label>
            <input type="text" id="totalBs" readonly value="0.00">
        </div>

        <div class="form-group">
            <label for="exchangeRate">Tasa de Cambio (Bs/USD)</label>
            <input type="number" id="exchangeRate" required min="0" step="0.01" value="64.74">
        </div>

        <div class="form-group">
            <label for="totalUsd">Total (USD)</label>
            <input type="text" id="totalUsd" readonly value="0.00">
        </div>

        <div class="form-group">
            <label for="paymentMethod">Método de Pago</label>
            <select id="paymentMethod" required disabled>
                <option value="Bolívares Efectivo">Bolívares Efectivo</option>
                <option value="Transferencia">Transferencia</option>
                <option value="Dólares Efectivo">Dólares Efectivo</option>
            </select>
        </div>

        <div class="form-group">
            <label for="orderStatus">Estado del Pedido</label>
            <select id="orderStatus" disabled>
                <option value="Borrador">Borrador</option>
                <option value="Enviado">Enviado</option>
                <option value="Pagado">Pagado</option>
                <option value="Finalizado">Finalizado</option>
            </select>
        </div>

        <div class="button-group">
            <button class="btn btn-secondary" id="backButton">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Regresar al Dashboard
            </button>
            <button class="btn" id="saveDraftButton">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm0 1h12v12H2V2zm4.5 10.5v-3h3v3h-3zm0-4.5v-3h5v3h-5z"/>
                </svg>
                Guardar Borrador
            </button>
            <button class="btn" id="sendOrderButton">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.893-1.405L12.53 2.88l1.6-.304Zm-3.404 3.404-1.405-.893 7.485-7.485-.304 1.6Z"/>
                </svg>
                Enviar Pedido
            </button>
            <button class="btn" id="confirmPaymentButton" disabled>
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/>
                </svg>
                Confirmar Pago
            </button>
            <button class="btn" id="generateInvoiceButton" disabled>
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h11A1.5 1.5 0 0 1 15 2.5v11a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 13.5v-11zM2.5 2a.5.5 0 0 0-.5.5v11a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5v-11a.5.5 0 0 0-.5-.5h-11z"/>
                    <path d="M4 4.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5z"/>
                </svg>
                Generar Factura
            </button>
        </div>
    </div>

    <div class="modal" id="sendOrderModal">
        <div class="modal-content">
            <span class="modal-close" id="sendOrderModalClose">×</span>
            <h3>Pedido Enviado</h3>
            <p>El pedido ha sido enviado exitosamente. Ahora puedes confirmar el pago o regresar al dashboard.</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="backToDashboardFromModal">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                    </svg>
                    Volver al Dashboard
                </button>
                <button class="btn" id="continueToPayment">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/>
                    </svg>
                    Continuar a Confirmar Pago
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="generateInvoiceModal">
        <div class="modal-content">
            <span class="modal-close" id="generateInvoiceModalClose">×</span>
            <h3>Generar Factura</h3>
            <p>¿Desea generar la factura para este pedido? Esta acción cambiará el estado del pedido a "Finalizado".</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelGenerateInvoice">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                    Cancelar
                </button>
                <button class="btn" id="confirmGenerateInvoice">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/>
                    </svg>
                    Generar Factura
                </button>
            </div>
        </div>
    </div>

    <script src="./jspdf.umd.min.js"></script>
    <script src="./jspdf.plugin.autotable.min.js"></script>

    <script>
        const { jsPDF } = window.jspdf;

        // Funciones de utilidad
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }

        function formatCurrency(amount) {
            return amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function loadUserData() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'index.html';
                return null;
            }
            return currentUser;
        }

        function addActivityEntry(currentUser, message) {
            const activityLog = JSON.parse(localStorage.getItem(`activity_${currentUser.rif}`)) || [];
            const timestamp = new Date().toLocaleString('es-ES');
            activityLog.unshift(`${timestamp}: ${message}`);
            if (activityLog.length > 10) activityLog.pop();
            localStorage.setItem(`activity_${currentUser.rif}`, JSON.stringify(activityLog));
        }

        function generateDocNumber() {
            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            const orderCount = orders.length + 1;
            return String(orderCount).padStart(8, '0');
        }

        function generateControlNumber() {
            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            const orderCount = orders.length + 1;
            return `00-${String(orderCount).padStart(8, '0')}`;
        }

        function calculateTotals() {
            const items = Array.from(document.querySelectorAll('#itemTableBody tr'));
            let subtotalBs = 0;

            items.forEach(item => {
                const quantity = parseFloat(item.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(item.querySelector('.item-price').value) || 0;
                const subtotal = quantity * price;
                item.querySelector('.item-subtotal').value = formatCurrency(subtotal);
                subtotalBs += subtotal;
            });

            const taxBs = subtotalBs * 0.16; // IVA 16%
            const totalBs = subtotalBs + taxBs;
            const exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 1;
            const totalUsd = totalBs / exchangeRate;

            document.getElementById('subtotalBs').value = formatCurrency(subtotalBs);
            document.getElementById('taxBs').value = formatCurrency(taxBs);
            document.getElementById('totalBs').value = formatCurrency(totalBs);
            document.getElementById('totalUsd').value = formatCurrency(totalUsd);

            return { subtotalBs, taxBs, totalBs, totalUsd };
        }

        function validateForm() {
            const clientId = document.getElementById('clientId').value.trim();
            const clientPhone = document.getElementById('clientPhone').value.trim();
            const clientEmail = document.getElementById('clientEmail').value.trim();
            const items = Array.from(document.querySelectorAll('#itemTableBody tr'));

            const clientIdRegex = /^[VEPGJ]-[0-9]{7,8}-[0-9]$/;
            if (!clientIdRegex.test(clientId)) {
                showAlert('El RIF/Cédula del cliente debe tener el formato V-12345678-9.', 'error');
                return false;
            }

            const phoneRegex = /^(\+58|0)[0-9]{10}$/;
            if (!phoneRegex.test(clientPhone)) {
                showAlert('El teléfono debe tener un formato válido, ej. +584121234567.', 'error');
                return false;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(clientEmail)) {
                showAlert('Por favor ingresa un correo electrónico válido.', 'error');
                return false;
            }

            if (items.length === 0) {
                showAlert('Debe agregar al menos un ítem al pedido.', 'error');
                return false;
            }

            for (const item of items) {
                const description = item.querySelector('.item-description').value.trim();
                const quantity = parseFloat(item.querySelector('.item-quantity').value);
                const price = parseFloat(item.querySelector('.item-price').value);

                if (!description) {
                    showAlert('La descripción de cada ítem es obligatoria.', 'error');
                    return false;
                }
                if (quantity <= 0) {
                    showAlert('La cantidad de cada ítem debe ser mayor a 0.', 'error');
                    return false;
                }
                if (price < 0) {
                    showAlert('El precio unitario no puede ser negativo.', 'error');
                    return false;
                }
            }

            return true;
        }

        function saveOrder(status) {
            if (!validateForm()) return;

            const currentUser = loadUserData();
            if (!currentUser) return;

            const totals = calculateTotals();
            const items = Array.from(document.querySelectorAll('#itemTableBody tr')).map(item => ({
                code: item.querySelector('.item-code').value.trim(),
                description: item.querySelector('.item-description').value.trim(),
                quantity: parseFloat(item.querySelector('.item-quantity').value),
                price: parseFloat(item.querySelector('.item-price').value),
                subtotal: parseFloat(item.querySelector('.item-subtotal').value.replace(/,/g, ''))
            }));

            const order = {
                id: document.getElementById('docNumber').value,
                docType: document.getElementById('docType').value,
                docNumber: document.getElementById('docNumber').value,
                controlNumber: document.getElementById('controlNumber').value,
                date: document.getElementById('date').value,
                clientName: document.getElementById('clientName').value.trim(),
                clientId: document.getElementById('clientId').value.trim(),
                clientAddress: document.getElementById('clientAddress').value.trim(),
                clientPhone: document.getElementById('clientPhone').value.trim(),
                clientEmails: [document.getElementById('clientEmail').value.trim()],
                items: items,
                subtotalBs: totals.subtotalBs,
                subtotalUsd: totals.subtotalBs / parseFloat(document.getElementById('exchangeRate').value),
                exemptAmountBs: 0,
                exemptAmountUsd: 0,
                taxableBaseBs: totals.subtotalBs,
                taxableBaseUsd: totals.subtotalBs / parseFloat(document.getElementById('exchangeRate').value),
                taxBs: totals.taxBs,
                taxUsd: totals.taxBs / parseFloat(document.getElementById('exchangeRate').value),
                igtfBs: 0,
                igtfUsd: 0,
                totalBs: totals.totalBs,
                totalUsd: totals.totalUsd,
                alicuota: 16,
                paymentMethod: document.getElementById('paymentMethod').value,
                exchangeRate: parseFloat(document.getElementById('exchangeRate').value),
                status: status,
                userRif: currentUser.rif
            };

            let orders = JSON.parse(localStorage.getItem('orders')) || [];
            const existingOrderIndex = orders.findIndex(o => o.id === order.id);
            if (existingOrderIndex !== -1) {
                orders[existingOrderIndex] = order;
            } else {
                orders.push(order);
            }
            localStorage.setItem('orders', JSON.stringify(orders));

            document.getElementById('orderStatus').value = status;
            addActivityEntry(currentUser, `Pedido ${order.docNumber} - Estado: ${status}`);

            if (status === 'Borrador') {
                showAlert('Pedido guardado como borrador.', 'success');
            } else if (status === 'Enviado') {
                showAlert('Pedido enviado exitosamente.', 'success');
                document.getElementById('confirmPaymentButton').disabled = false;
                document.getElementById('paymentMethod').disabled = false; // Habilitar edición del método de pago
                document.getElementById('sendOrderModal').style.display = 'flex'; // Mostrar modal
            } else if (status === 'Pagado') {
                showAlert('Pago confirmado.', 'success');
                document.getElementById('generateInvoiceButton').disabled = false;
                document.getElementById('generateInvoiceModal').style.display = 'flex';
            } else if (status === 'Finalizado') {
                showAlert('Factura generada. Pedido finalizado.', 'success');
                document.getElementById('generateInvoiceButton').disabled = true;
                document.getElementById('confirmPaymentButton').disabled = true;
            }
        }

        function generateInvoice() {
            const currentUser = loadUserData();
            if (!currentUser) return;

            const order = JSON.parse(localStorage.getItem('orders')).find(o => o.id === document.getElementById('docNumber').value);
            if (!order) {
                showAlert('No se encontró el pedido para generar la factura.', 'error');
                return;
            }

            const templateId = localStorage.getItem('selectedTemplate') || 1;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4',
                putOnlyUsedFonts: true,
                floatPrecision: 16,
                compress: true
            });
            const logo = currentUser.profilePic || 'https://via.placeholder.com/100';
            const margin = 5;
            const pageWidth = doc.internal.pageSize.getWidth() - 2 * margin;
            let y = margin;

            function addText(text, x, align = 'left') {
                const lines = doc.splitTextToSize(text, pageWidth - 10);
                lines.forEach(line => {
                    if (y > doc.internal.pageSize.getHeight() - 10) {
                        doc.addPage();
                        y = margin;
                    }
                    doc.text(line, x, y, { align: align });
                    y += 3;
                });
                return y;
            }

            if (templateId == 1) {
                doc.addImage(logo, 'JPEG', (pageWidth / 2) + margin - 15, y, 30, 30, undefined, 'FAST');
                y += 35;
                doc.setFontSize(12);
                y = addText(currentUser.companyName, (pageWidth / 2) + margin, 'center');
                doc.setFontSize(8);
                y = addText(`RIF: ${currentUser.rif}`, (pageWidth / 2) + margin, 'center');
                y = addText(`Dirección: ${currentUser.address}`, (pageWidth / 2) + margin, 'center');
                y = addText(`Teléfono: ${currentUser.phone}`, (pageWidth / 2) + margin, 'center');
                y += 5;
                doc.setFontSize(12);
                y = addText('Factura', margin, 'left');
                doc.setFontSize(8);
                y = addText(`Nº Documento: ${order.docNumber}`, margin, 'left');
                y = addText(`Nº Control: ${order.controlNumber}`, margin, 'left');
                y = addText(`Fecha: ${order.date}`, margin, 'left');
                y += 5;
                y = addText(`Cliente: ${order.clientName}`, margin, 'left');
                y = addText(`RIF/Cédula: ${order.clientId}`, margin, 'left');
                y = addText(`Dirección: ${order.clientAddress}`, margin, 'left');
                y = addText(`Teléfono: ${order.clientPhone}`, margin, 'left');
                y = addText(`Correos: ${order.clientEmails.join(', ')}`, margin, 'left');
            } else if (templateId == 2) {
                doc.addImage(logo, 'JPEG', margin, y, 30, 30, undefined, 'FAST');
                doc.setFontSize(12);
                y = addText(currentUser.companyName, margin + 35, 'left');
                doc.setFontSize(8);
                y = addText(`RIF: ${currentUser.rif}`, margin + 35, 'left');
                y += 5;
                doc.setFontSize(12);
                y = addText('Factura', pageWidth + margin, 'right');
                doc.setFontSize(8);
                y = addText(`Nº Documento: ${order.docNumber}`, pageWidth + margin, 'right');
                y = addText(`Nº Control: ${order.controlNumber}`, pageWidth + margin, 'right');
                y = addText(`Fecha: ${order.date}`, pageWidth + margin, 'right');
                y += 5;
                y = addText(`Cliente: ${order.clientName}`, margin, 'left');
                y = addText(`RIF/Cédula: ${order.clientId}`, margin, 'left');
                y = addText(`Dirección: ${order.clientAddress}`, margin, 'left');
                y = addText(`Teléfono: ${order.clientPhone}`, margin, 'left');
                y = addText(`Correos: ${order.clientEmails.join(', ')}`, margin, 'left');
            } else if (templateId == 3) {
                doc.addImage(logo, 'JPEG', (pageWidth / 2) + margin - 15, y, 30, 30, undefined, 'FAST');
                y += 35;
                doc.setFontSize(12);
                y = addText(currentUser.companyName, (pageWidth / 2) + margin, 'center');
                doc.setFontSize(8);
                y = addText(`RIF: ${currentUser.rif}`, (pageWidth / 2) + margin, 'center');
                y = addText(`Dirección: ${currentUser.address}`, (pageWidth / 2) + margin, 'center');
                y = addText(`Teléfono: ${currentUser.phone}`, (pageWidth / 2) + margin, 'center');
                y += 5;
                doc.setFontSize(12);
                y = addText('Factura', margin, 'left');
                doc.setFontSize(8);
                y = addText(`Nº Documento: ${order.docNumber}`, margin, 'left');
                y = addText(`Nº Control: ${order.controlNumber}`, margin, 'left');
                y = addText(`Fecha: ${order.date}`, margin, 'left');
                y += 5;
                y = addText(`Cliente: ${order.clientName}`, margin, 'left');
                y = addText(`RIF/Cédula: ${order.clientId}`, margin, 'left');
                y = addText(`Dirección: ${order.clientAddress}`, margin, 'left');
                y = addText(`Teléfono: ${order.clientPhone}`, margin, 'left');
                y = addText(`Correos: ${order.clientEmails.join(', ')}`, margin, 'left');
            }

            y += 5;
            doc.autoTable({
                head: [['Código', 'Descripción', 'Cantidad', 'Precio Unitario (Bs)', 'Subtotal (Bs)']],
                body: order.items.map(item => [
                    item.code || '-',
                    item.description,
                    item.quantity,
                    formatCurrency(item.price),
                    formatCurrency(item.subtotal)
                ]),
                startY: y,
                theme: 'striped',
                styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                columnStyles: { 0: { cellWidth: 15 }, 1: { cellWidth: 50 }, 2: { cellWidth: 15 }, 3: { cellWidth: 25 }, 4: { cellWidth: 25 } },
                margin: { top: margin },
                didDrawPage: () => { y = doc.lastAutoTable.finalY + 3; }
            });
            y = doc.lastAutoTable.finalY + 3;

            const totalTableData = [
                ['Subtotal', formatCurrency(order.subtotalBs), formatCurrency(order.subtotalUsd)],
                ['Monto exento', formatCurrency(order.exemptAmountBs), formatCurrency(order.exemptAmountUsd)],
                ['Base imponible', formatCurrency(order.taxableBaseBs), formatCurrency(order.taxableBaseUsd)],
                [`IVA (${order.alicuota}%)`, formatCurrency(order.taxBs), formatCurrency(order.taxUsd)],
                ['IGTF (3%)', formatCurrency(order.igtfBs), formatCurrency(order.igtfUsd)],
                ['Total', formatCurrency(order.totalBs), formatCurrency(order.totalUsd)]
            ];

            doc.autoTable({
                head: [['', 'Bs', 'USD']],
                body: totalTableData,
                startY: y,
                theme: 'striped',
                styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                columnStyles: { 0: { cellWidth: 30 }, 1: { cellWidth: 30 }, 2: { cellWidth: 30 } },
                margin: { left: pageWidth - 90 + margin },
                didDrawPage: () => { y = doc.lastAutoTable.finalY + 3; }
            });
            y = doc.lastAutoTable.finalY + 3;

            doc.setFontSize(8);
            y = addText(`Método de Pago: ${order.paymentMethod}`, margin, 'left');
            y = addText(`Tasa de cambio: ${order.exchangeRate} Bs/USD`, margin, 'left');
            y += 5;
            doc.setFontSize(7);
            doc.setTextColor(100);
            doc.setLineWidth(0.5);
            doc.line(margin, y, pageWidth + margin, y);
            y += 3;
            y = addText(`Este documento se emite bajo la Providencia Administrativa SNAT/2024/000102 de fecha 17/10/2024 SOLUCIONES LASER, CA, RIF: J-003629162.`, (pageWidth / 2) + margin, 'center');

            doc.save(`Factura_${order.docNumber}.pdf`);
            saveOrder('Finalizado');
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = loadUserData();
            if (!currentUser) return;

            if (currentUser.darkTheme) {
                document.body.classList.add('dark-theme');
            }

            document.getElementById('docNumber').value = generateDocNumber();
            document.getElementById('controlNumber').value = generateControlNumber();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];

            document.getElementById('addItemButton').addEventListener('click', () => {
                const tbody = document.getElementById('itemTableBody');
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td><input type="text" class="item-code" placeholder="001"></td>
                    <td><input type="text" class="item-description" required></td>
                    <td><input type="number" class="item-quantity" required min="1" value="1"></td>
                    <td><input type="number" class="item-price" required min="0" step="0.01" value="0"></td>
                    <td><input type="text" class="item-subtotal" readonly value="0.00"></td>
                    <td>
                        <button class="btn btn-danger btn-remove-item">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                            </svg>
                            Eliminar
                        </button>
                    </td>
                `;
                tbody.appendChild(newRow);
                calculateTotals();
            });

            document.getElementById('itemTableBody').addEventListener('click', (e) => {
                if (e.target.closest('.btn-remove-item')) {
                    const row = e.target.closest('tr');
                    if (document.querySelectorAll('#itemTableBody tr').length > 1) {
                        row.remove();
                        calculateTotals();
                    } else {
                        showAlert('Debe haber al menos un ítem en el pedido.', 'error');
                    }
                }
            });

            document.getElementById('itemTableBody').addEventListener('input', (e) => {
                if (e.target.classList.contains('item-quantity') || e.target.classList.contains('item-price')) {
                    calculateTotals();
                }
            });

            document.getElementById('exchangeRate').addEventListener('input', calculateTotals);

            document.getElementById('saveDraftButton').addEventListener('click', () => {
                saveOrder('Borrador');
            });

            document.getElementById('sendOrderButton').addEventListener('click', () => {
                saveOrder('Enviado');
            });

            document.getElementById('confirmPaymentButton').addEventListener('click', () => {
                saveOrder('Pagado');
            });

            document.getElementById('generateInvoiceButton').addEventListener('click', () => {
                document.getElementById('generateInvoiceModal').style.display = 'flex';
            });

            document.getElementById('confirmGenerateInvoice').addEventListener('click', () => {
                document.getElementById('generateInvoiceModal').style.display = 'none';
                generateInvoice();
            });

            document.getElementById('cancelGenerateInvoice').addEventListener('click', () => {
                document.getElementById('generateInvoiceModal').style.display = 'none';
            });

            document.getElementById('generateInvoiceModalClose').addEventListener('click', () => {
                document.getElementById('generateInvoiceModal').style.display = 'none';
            });

            document.getElementById('sendOrderModalClose').addEventListener('click', () => {
                document.getElementById('sendOrderModal').style.display = 'none';
            });

            document.getElementById('backToDashboardFromModal').addEventListener('click', () => {
                window.location.href = 'dashboard.html';
            });

            document.getElementById('continueToPayment').addEventListener('click', () => {
                document.getElementById('sendOrderModal').style.display = 'none';
                saveOrder('Pagado');
            });

            document.getElementById('backButton').addEventListener('click', () => {
                window.location.href = 'dashboard.html';
            });

            // Actualizar método de pago
            document.getElementById('paymentMethod').addEventListener('change', () => {
                const orderId = document.getElementById('docNumber').value;
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                const orderIndex = orders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    orders[orderIndex].paymentMethod = document.getElementById('paymentMethod').value;
                    localStorage.setItem('orders', JSON.stringify(orders));
                    addActivityEntry(currentUser, `Método de pago actualizado para el pedido ${orderId}`);
                    showAlert('Método de pago actualizado.', 'success');
                }
            });
        });
    </script>
</body>
</html>
