<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Facture - Nuevo Documento</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(120deg, #f6f9fc 0%, #ffffff 100%);
            color: #1a1a1a;
            line-height: 1.5;
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body.dark-theme {
            background: linear-gradient(120deg, #1f2a44 0%, #2c3e50 100%);
            color: #d1d8e0;
        }

        /* Navbar */
        .navbar {
            background: #034f9e;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 6px 15px rgba(3, 79, 158, 0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: background 0.3s ease;
        }

        .dark-theme .navbar {
            background: #023e8a;
            box-shadow: 0 6px 15px rgba(2, 62, 138, 0.2);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .back-btn {
            background: #258D19;
            color: #fff;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #1e7214;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(37, 141, 25, 0.25);
        }

        .logo img {
            height: 40px;
            transition: transform 0.3s ease;
        }

        .logo img:hover {
            transform: scale(1.05);
        }

        /* Main Container */
        .container {
            max-width: 1300px;
            margin: 1.5rem auto;
            padding: 1.5rem;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
            animation: slideUp 0.5s ease-out;
        }

        .dark-theme .container {
            background: #2c3e50;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #034f9e;
            margin-bottom: 1rem;
            position: relative;
            display: inline-block;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 40%;
            height: 3px;
            background: #258D19;
            border-radius: 2px;
        }

        .dark-theme .section-title {
            color: #4aafff;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 0.3rem;
        }

        .dark-theme label {
            color: #a1a1aa;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e6f0ff;
            border-radius: 6px;
            font-size: 0.75rem;
            background: #f8faff;
            transition: all 0.3s ease;
        }

        .dark-theme input, .dark-theme select, .dark-theme textarea {
            background: #34495e;
            border-color: #34495e;
            color: #d1d8e0;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #034f9e;
            box-shadow: 0 0 6px rgba(3, 79, 158, 0.2);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Table Styles */
        .item-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.5rem;
            margin-bottom: 1rem;
        }

        .item-table th, .item-table td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            font-size: 0.75rem;
        }

        .item-table th {
            background: #034f9e;
            color: #fff;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .dark-theme .item-table th {
            background: #023e8a;
        }

        .item-table tr {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .item-table tr:hover {
            background: #f8faff;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(3, 79, 158, 0.1);
        }

        .dark-theme .item-table tr {
            background: #34495e;
        }

        .dark-theme .item-table tr:hover {
            background: #3e5a75;
        }

        .item-table input {
            width: 100%;
            padding: 0.5rem;
            border: none;
            background: transparent;
            font-size: 0.75rem;
            color: #1a1a1a;
        }

        .dark-theme .item-table input {
            color: #d1d8e0;
        }

        .item-table input:focus {
            border: 1px solid #034f9e;
            border-radius: 4px;
            outline: none;
        }

        /* Buttons */
        .btn {
            background: #034f9e;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: #023e8a;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(3, 79, 158, 0.25);
        }

        .btn-secondary {
            background: #258D19;
        }

        .btn-secondary:hover {
            background: #1e7214;
            box-shadow: 0 4px 10px rgba(37, 141, 25, 0.25);
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.25);
        }

        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        /* Alerts */
        .alert {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            z-index: 1001;
            font-size: 0.85rem;
            font-weight: 500;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success {
            background: #258D19;
            color: #fff;
        }

        .dark-theme .alert-success {
            background: #3db32e;
        }

        .alert-error {
            background: #dc3545;
            color: #fff;
        }

        .dark-theme .alert-error {
            background: #e04b59;
        }

        /* Form Row */
        .form-row {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                margin: 1rem;
                padding: 1rem;
            }
            .button-group {
                justify-content: center;
            }
            .item-table th, .item-table td {
                padding: 0.4rem;
                font-size: 0.65rem;
            }
            .form-row {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="logo-section">
            <button class="back-btn" id="backButton">←</button>
            <div class="logo">
                <img src="Logo E-facture-02.png" alt="Logo E-Facture">
            </div>
        </div>
    </header>

    <div class="container">
        <h2 class="section-title" id="pageTitle">Nuevo Documento</h2>

        <div class="form-group">
            <label for="docType">Tipo de Documento</label>
            <select id="docType" required>
                <option value="factura">Factura</option>
                <option value="nota-entrega">Nota de Entrega</option>
            </select>
        </div>

        <div class="form-group">
            <label for="docNumber">Nº Documento</label>
            <input type="text" id="docNumber" required readonly value="Generado automáticamente">
        </div>

        <div class="form-group">
            <label for="date">Fecha</label>
            <input type="date" id="date" required>
        </div>

        <div class="form-group">
            <label for="clientName">Nombre del Cliente</label>
            <input type="text" id="clientName" required>
        </div>

        <div class="form-group">
            <label>Tipo de Identificación del Cliente</label>
            <div class="form-row">
                <div style="flex: 1;">
                    <label for="clientIdType">Tipo</label>
                    <select id="clientIdType" required>
                        <option value="cedula">Cédula</option>
                        <option value="rif">RIF</option>
                        <option value="extranjero">Extranjero</option>
                    </select>
                </div>
                <div style="flex: 2;">
                    <label for="clientIdNumber">Número</label>
                    <input type="text" id="clientIdNumber" required placeholder="Ejemplo: 12345678">
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="clientAddress">Dirección del Cliente</label>
            <textarea id="clientAddress" required></textarea>
        </div>

        <div class="form-group">
            <label for="clientPhone">Teléfono del Cliente</label>
            <input type="text" id="clientPhone" required placeholder="Ejemplo: +584121234567">
        </div>

        <div class="form-group">
            <label for="clientEmails">Correos del Cliente (separados por comas)</label>
            <input type="text" id="clientEmails" required placeholder="correo1@ejemplo.com, correo2@ejemplo.com">
        </div>

        <div class="form-group">
            <h3 class="section-title">Ítems del Documento</h3>
            <table class="item-table" id="itemTable">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Descripción</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario (Bs)</th>
                        <th>Subtotal (Bs)</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="itemTableBody">
                    <tr>
                        <td><input type="text" class="item-code" placeholder="001"></td>
                        <td><input type="text" class="item-description" required></td>
                        <td><input type="number" class="item-quantity" required min="1" value="1"></td>
                        <td><input type="number" class="item-price" required min="0" step="0.01" value="0"></td>
                        <td><input type="text" class="item-subtotal" readonly value="0.00"></td>
                        <td>
                            <button class="btn btn-danger btn-remove-item">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                </svg>
                                Eliminar
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <button class="btn" id="addItemButton">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                Agregar Ítem
            </button>
        </div>

        <div class="form-group">
            <label for="subtotalBs">Subtotal (Bs)</label>
            <input type="text" id="subtotalBs" readonly value="0.00">
        </div>

        <div class="form-group">
            <label for="taxBs">IVA (16%) (Bs)</label>
            <input type="text" id="taxBs" readonly value="0.00">
        </div>

        <div class="form-group">
            <label for="igtfBs">IGTF (3% sobre pagos en USD) (Bs)</label>
            <input type="text" id="igtfBs" readonly value="0.00">
        </div>

        <div class="form-group">
            <label for="totalBs">Total (Bs)</label>
            <input type="text" id="totalBs" readonly value="0.00">
        </div>

        <div class="form-group">
            <label for="exchangeRate">Tasa de Cambio (Bs/USD)</label>
            <input type="number" id="exchangeRate" required min="0" step="0.01" value="64.74">
        </div>

        <div class="form-group">
            <label for="totalUsd">Total (USD)</label>
            <input type="text" id="totalUsd" readonly value="0.00">
        </div>

        <div class="form-group">
            <h3 class="section-title">Detalles de Pago</h3>
            <label for="paymentMethod">Método de Pago</label>
            <select id="paymentMethod" required>
                <option value="Pago Móvil">Pago Móvil</option>
                <option value="Efectivo Bolívares">Efectivo Bolívares</option>
                <option value="Efectivo Dólares">Efectivo Dólares</option>
                <option value="Transferencia Bolívares">Transferencia Bolívares</option>
                <option value="Transferencia Dólares">Transferencia Dólares</option>
                <option value="Mixto">Pago Mixto (Bs y USD)</option>
            </select>
        </div>

        <div class="form-group" id="mixedPaymentFields" style="display: none;">
            <div class="form-row">
                <div style="flex: 1;">
                    <label for="amountBs">Monto en Bolívares (Bs)</label>
                    <input type="number" id="amountBs" min="0" step="0.01" value="0">
                </div>
                <div style="flex: 1;">
                    <label for="amountUsd">Monto en Dólares (USD)</label>
                    <input type="number" id="amountUsd" min="0" step="0.01" value="0">
                </div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn btn-secondary" id="backButtonDashboard">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Regresar al Dashboard
            </button>
            <button class="btn" id="saveDraftButton">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm0 1h12v12H2V2zm4.5 10.5v-3h3v3h-3zm0-4.5v-3h5v3h-5z"/>
                </svg>
                Guardar Borrador
            </button>
            <button class="btn" id="sendOrderButton">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.893-1.405L12.53 2.88l1.6-.304Zm-3.404 3.404-1.405-.893 7.485-7.485-.304 1.6Z"/>
                </svg>
                Enviar Documento
            </button>
        </div>
    </div>

    <script>
        // ---- Funciones de Utilidad ----
        // Muestra una alerta temporal en la pantalla
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }

        // Formatea un número como moneda con separadores de miles
        function formatCurrency(amount) {
            return amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        // Carga los datos del usuario actual desde localStorage
        function loadUserData() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'index.html';
                return null;
            }
            return currentUser;
        }

        // Agrega una entrada al historial de actividad del usuario
        function addActivityEntry(currentUser, message) {
            const activityLog = JSON.parse(localStorage.getItem(`activity_${currentUser.rif}`)) || [];
            const timestamp = new Date().toLocaleString('es-ES');
            activityLog.unshift(`${timestamp}: ${message}`);
            if (activityLog.length > 10) activityLog.pop();
            localStorage.setItem(`activity_${currentUser.rif}`, JSON.stringify(activityLog));
        }

        // Genera un número de documento único basado en los pedidos existentes
        function generateDocNumber() {
            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            const userOrders = orders.filter(order => order.userRif === loadUserData().rif);
            const orderCount = userOrders.length + 1;
            return String(orderCount).padStart(8, '0');
        }

        // Formatea el ID del cliente según el tipo (Cédula, RIF, Extranjero)
        function formatClientId(type, number) {
            const cleanNumber = number.replace(/[^0-9]/g, '');
            if (cleanNumber.length < 7 || cleanNumber.length > 8) {
                return null;
            }
            if (type === 'cedula') {
                return `V-${cleanNumber}`;
            } else if (type === 'rif') {
                const checkDigit = Math.floor(Math.random() * 10);
                return `J-${cleanNumber}-${checkDigit}`;
            } else if (type === 'extranjero') {
                return `E-${cleanNumber}`;
            }
            return null;
        }

        // ---- Cálculo de Totales incluyendo IGTF ----
        function calculateTotals() {
            const items = Array.from(document.querySelectorAll('#itemTableBody tr'));
            let subtotalBs = 0;

            // Calcula el subtotal en Bolívares basado en los ítems
            items.forEach(item => {
                const quantity = parseFloat(item.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(item.querySelector('.item-price').value) || 0;
                const subtotal = quantity * price;
                item.querySelector('.item-subtotal').value = formatCurrency(subtotal);
                subtotalBs += subtotal;
            });

            const taxBs = subtotalBs * 0.16; // IVA del 16%
            const exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 1;
            const paymentMethod = document.getElementById('paymentMethod').value;
            let igtfBs = 0;
            let totalBs = 0;
            let totalUsd = 0;

            // Si el pago involucra dólares, calcula el IGTF (3%)
            if (paymentMethod.includes('Dólares') || paymentMethod === 'Mixto') {
                const amountUsd = parseFloat(document.getElementById('amountUsd').value) || 0;
                const amountUsdInBs = amountUsd * exchangeRate;
                igtfBs = amountUsdInBs * 0.03; // IGTF del 3% sobre el monto en USD
            }

            totalBs = subtotalBs + taxBs + igtfBs;
            totalUsd = totalBs / exchangeRate;

            // Actualiza los campos en la interfaz
            document.getElementById('subtotalBs').value = formatCurrency(subtotalBs);
            document.getElementById('taxBs').value = formatCurrency(taxBs);
            document.getElementById('igtfBs').value = formatCurrency(igtfBs);
            document.getElementById('totalBs').value = formatCurrency(totalBs);
            document.getElementById('totalUsd').value = formatCurrency(totalUsd);

            return { subtotalBs, taxBs, igtfBs, totalBs, totalUsd };
        }

        // ---- Validación del Formulario ----
        function validateForm() {
            const clientIdType = document.getElementById('clientIdType').value;
            const clientIdNumber = document.getElementById('clientIdNumber').value.trim();
            const clientPhone = document.getElementById('clientPhone').value.trim();
            const clientEmails = document.getElementById('clientEmails').value.trim();
            const items = Array.from(document.querySelectorAll('#itemTableBody tr'));
            const paymentMethod = document.getElementById('paymentMethod').value;
            const totalBs = parseFloat(document.getElementById('totalBs').value.replace(/,/g, '')) || 0;
            const amountBs = parseFloat(document.getElementById('amountBs').value) || 0;
            const amountUsd = parseFloat(document.getElementById('amountUsd').value) || 0;
            const exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 1;

            // Valida el ID del cliente
            const formattedId = formatClientId(clientIdType, clientIdNumber);
            if (!formattedId) {
                showAlert('El número de identificación debe tener entre 7 y 8 dígitos numéricos.', 'error');
                return false;
            }

            // Valida el teléfono
            const phoneRegex = /^(\+58|0)[0-9]{10}$/;
            if (!phoneRegex.test(clientPhone)) {
                showAlert('El teléfono debe tener un formato válido, ej. +584121234567.', 'error');
                return false;
            }

            // Valida los correos electrónicos
            const emailArray = clientEmails.split(',').map(email => email.trim()).filter(email => email);
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            for (const email of emailArray) {
                if (!emailRegex.test(email)) {
                    showAlert(`El correo "${email}" no es válido.`, 'error');
                    return false;
                }
            }
            if (emailArray.length === 0) {
                showAlert('Debe ingresar al menos un correo electrónico válido.', 'error');
                return false;
            }

            // Valida que haya al menos un ítem
            if (items.length === 0) {
                showAlert('Debe agregar al menos un ítem al documento.', 'error');
                return false;
            }

            // Valida los ítems individuales
            for (const item of items) {
                const description = item.querySelector('.item-description').value.trim();
                const quantity = parseFloat(item.querySelector('.item-quantity').value);
                const price = parseFloat(item.querySelector('.item-price').value);

                if (!description) {
                    showAlert('La descripción de cada ítem es obligatoria.', 'error');
                    return false;
                }
                if (quantity <= 0) {
                    showAlert('La cantidad de cada ítem debe ser mayor a 0.', 'error');
                    return false;
                }
                if (price < 0) {
                    showAlert('El precio unitario no puede ser negativo.', 'error');
                    return false;
                }
            }

            // Valida los montos de pago mixto
            if (paymentMethod === 'Mixto') {
                const totalUsdEquivalent = totalBs / exchangeRate;
                const amountBsInUsd = amountBs / exchangeRate;
                const totalPaidInUsd = amountBsInUsd + amountUsd;

                if (amountBs < 0 || amountUsd < 0) {
                    showAlert('Los montos de pago no pueden ser negativos.', 'error');
                    return false;
                }
                if (totalPaidInUsd < totalUsdEquivalent - 0.01 || totalPaidInUsd > totalUsdEquivalent + 0.01) {
                    showAlert('El total pagado en Bs y USD no coincide con el total del documento.', 'error');
                    return false;
                }
            }

            return true;
        }

        // ---- Guardar el Pedido ----
        function saveOrder(status) {
            if (!validateForm()) return;

            const currentUser = loadUserData();
            if (!currentUser) return;

            const totals = calculateTotals();
            const items = Array.from(document.querySelectorAll('#itemTableBody tr')).map(item => ({
                code: item.querySelector('.item-code').value.trim(),
                description: item.querySelector('.item-description').value.trim(),
                quantity: parseFloat(item.querySelector('.item-quantity').value),
                price: parseFloat(item.querySelector('.item-price').value),
                subtotal: parseFloat(item.querySelector('.item-subtotal').value.replace(/,/g, ''))
            }));

            const clientIdType = document.getElementById('clientIdType').value;
            const clientIdNumber = document.getElementById('clientIdNumber').value.trim();
            const formattedClientId = formatClientId(clientIdType, clientIdNumber);
            const clientEmails = document.getElementById('clientEmails').value.split(',').map(email => email.trim()).filter(email => email);
            const paymentMethod = document.getElementById('paymentMethod').value;
            const exchangeRate = parseFloat(document.getElementById('exchangeRate').value);

            // Detalles de pago mixto
            const paymentDetails = {
                method: paymentMethod,
                amountBs: paymentMethod === 'Mixto' ? parseFloat(document.getElementById('amountBs').value) : (paymentMethod.includes('Bolívares') ? totals.totalBs : 0),
                amountUsd: paymentMethod === 'Mixto' ? parseFloat(document.getElementById('amountUsd').value) : (paymentMethod.includes('Dólares') ? totals.totalUsd : 0)
            };

            const order = {
                docType: document.getElementById('docType').value,
                docNumber: document.getElementById('docNumber').value,
                date: document.getElementById('date').value,
                clientName: document.getElementById('clientName').value.trim(),
                clientId: formattedClientId,
                clientAddress: document.getElementById('clientAddress').value.trim(),
                clientPhone: document.getElementById('clientPhone').value.trim(),
                clientEmails: clientEmails,
                items: items,
                subtotalBs: totals.subtotalBs,
                subtotalUsd: totals.subtotalBs / exchangeRate,
                exemptAmountBs: 0,
                exemptAmountUsd: 0,
                taxableBaseBs: totals.subtotalBs,
                taxableBaseUsd: totals.subtotalBs / exchangeRate,
                taxBs: totals.taxBs,
                taxUsd: totals.taxBs / exchangeRate,
                igtfBs: totals.igtfBs,
                igtfUsd: totals.igtfBs / exchangeRate,
                totalBs: totals.totalBs,
                totalUsd: totals.totalUsd,
                alicuota: 16,
                paymentDetails: paymentDetails,
                exchangeRate: exchangeRate,
                status: status,
                userRif: currentUser.rif
            };

            let orders = JSON.parse(localStorage.getItem('orders')) || [];
            const existingOrderIndex = orders.findIndex(o => o.docNumber === order.docNumber && o.userRif === order.userRif);
            if (existingOrderIndex !== -1) {
                orders[existingOrderIndex] = order;
            } else {
                orders.push(order);
            }
            localStorage.setItem('orders', JSON.stringify(orders));

            addActivityEntry(currentUser, `Documento ${order.docNumber} - Estado: ${status}`);

            if (status === 'draft') {
                showAlert('Documento guardado como borrador.', 'success');
            } else if (status === 'pending') {
                showAlert('Documento enviado exitosamente.', 'success');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);
            }
        }

        // ---- Cargar Pedido para Edición ----
        function loadOrderForEdit() {
            const urlParams = new URLSearchParams(window.location.search);
            const editDocNumber = urlParams.get('edit');
            if (editDocNumber) {
                const editOrder = JSON.parse(localStorage.getItem('editOrder'));
                if (editOrder && editOrder.docNumber === editDocNumber) {
                    document.getElementById('pageTitle').textContent = 'Editar Documento';
                    document.getElementById('docType').value = editOrder.docType;
                    document.getElementById('docNumber').value = editOrder.docNumber;
                    document.getElementById('date').value = editOrder.date;
                    document.getElementById('clientName').value = editOrder.clientName;

                    const [idPrefix, idNumber] = editOrder.clientId.split('-');
                    document.getElementById('clientIdType').value = idPrefix === 'V' ? 'cedula' : idPrefix === 'J' ? 'rif' : 'extranjero';
                    document.getElementById('clientIdNumber').value = idNumber;

                    document.getElementById('clientAddress').value = editOrder.clientAddress;
                    document.getElementById('clientPhone').value = editOrder.clientPhone;
                    document.getElementById('clientEmails').value = editOrder.clientEmails.join(', ');
                    document.getElementById('exchangeRate').value = editOrder.exchangeRate;
                    document.getElementById('paymentMethod').value = editOrder.paymentDetails.method;

                    const tbody = document.getElementById('itemTableBody');
                    tbody.innerHTML = '';
                    editOrder.items.forEach(item => {
                        const newRow = document.createElement('tr');
                        newRow.innerHTML = `
                            <td><input type="text" class="item-code" value="${item.code || ''}" placeholder="001"></td>
                            <td><input type="text" class="item-description" value="${item.description}" required></td>
                            <td><input type="number" class="item-quantity" value="${item.quantity}" required min="1"></td>
                            <td><input type="number" class="item-price" value="${item.price}" required min="0" step="0.01"></td>
                            <td><input type="text" class="item-subtotal" readonly value="${formatCurrency(item.subtotal)}"></td>
                            <td>
                                <button class="btn btn-danger btn-remove-item">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                    </svg>
                                    Eliminar
                                </button>
                            </td>
                        `;
                        tbody.appendChild(newRow);
                    });

                    // Carga los detalles de pago mixto si aplica
                    if (editOrder.paymentDetails.method === 'Mixto') {
                        document.getElementById('mixedPaymentFields').style.display = 'block';
                        document.getElementById('amountBs').value = editOrder.paymentDetails.amountBs;
                        document.getElementById('amountUsd').value = editOrder.paymentDetails.amountUsd;
                    }

                    calculateTotals();
                }
            }
        }

        // ---- Inicialización y Eventos ----
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = loadUserData();
            if (!currentUser) return;

            // Aplica el tema oscuro si está configurado
            if (currentUser.darkTheme) {
                document.body.classList.add('dark-theme');
            }

            // Carga un pedido para edición si existe
            loadOrderForEdit();

            // Genera el número de documento si no es una edición
            if (!new URLSearchParams(window.location.search).get('edit')) {
                document.getElementById('docNumber').value = generateDocNumber();
            }
            document.getElementById('date').value = new Date().toISOString().split('T')[0];

            // Evento para agregar un nuevo ítem
            document.getElementById('addItemButton').addEventListener('click', () => {
                const tbody = document.getElementById('itemTableBody');
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td><input type="text" class="item-code" placeholder="001"></td>
                    <td><input type="text" class="item-description" required></td>
                    <td><input type="number" class="item-quantity" required min="1" value="1"></td>
                    <td><input type="number" class="item-price" required min="0" step="0.01" value="0"></td>
                    <td><input type="text" class="item-subtotal" readonly value="0.00"></td>
                    <td>
                        <button class="btn btn-danger btn-remove-item">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                            </svg>
                            Eliminar
                        </button>
                    </td>
                `;
                tbody.appendChild(newRow);
                calculateTotals();
            });

            // Evento para eliminar un ítem
            document.getElementById('itemTableBody').addEventListener('click', (e) => {
                if (e.target.closest('.btn-remove-item')) {
                    const row = e.target.closest('tr');
                    if (document.querySelectorAll('#itemTableBody tr').length > 1) {
                        row.remove();
                        calculateTotals();
                    } else {
                        showAlert('Debe haber al menos un ítem en el documento.', 'error');
                    }
                }
            });

            // Evento para recalcular totales al cambiar cantidad o precio
            document.getElementById('itemTableBody').addEventListener('input', (e) => {
                if (e.target.classList.contains('item-quantity') || e.target.classList.contains('item-price')) {
                    calculateTotals();
                }
            });

            // Evento para recalcular totales al cambiar la tasa de cambio
            document.getElementById('exchangeRate').addEventListener('input', calculateTotals);

            // Evento para mostrar/ocultar campos de pago mixto
            document.getElementById('paymentMethod').addEventListener('change', (e) => {
                const mixedPaymentFields = document.getElementById('mixedPaymentFields');
                mixedPaymentFields.style.display = e.target.value === 'Mixto' ? 'block' : 'none';
                calculateTotals();

                const docNumber = document.getElementById('docNumber').value;
                let orders = JSON.parse(localStorage.getItem('orders')) || [];
                const orderIndex = orders.findIndex(o => o.docNumber === docNumber && o.userRif === currentUser.rif);
                if (orderIndex !== -1) {
                    orders[orderIndex].paymentDetails.method = e.target.value;
                    localStorage.setItem('orders', JSON.stringify(orders));
                    addActivityEntry(currentUser, `Método de pago actualizado para el documento ${docNumber}`);
                    showAlert('Método de pago actualizado.', 'success');
                }
            });

            // Evento para recalcular IGTF al cambiar montos de pago mixto
            document.getElementById('amountBs').addEventListener('input', calculateTotals);
            document.getElementById('amountUsd').addEventListener('input', calculateTotals);

            // Evento para guardar como borrador
            document.getElementById('saveDraftButton').addEventListener('click', () => {
                saveOrder('draft');
            });

            // Evento para enviar el documento
            document.getElementById('sendOrderButton').addEventListener('click', () => {
                saveOrder('pending');
            });

            // Evento para regresar al índice
            document.getElementById('backButton').addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            // Evento para regresar al dashboard
            document.getElementById('backButtonDashboard').addEventListener('click', () => {
                window.location.href = 'dashboard.html';
            });
        });
    </script>
</body>
</html>
